{"title":"BGP详解","slug":"CCNP/CCNP路由 BGP","date":"2024-11-21T01:01:46.000Z","updated":"2025-08-01T15:15:09.947Z","comments":true,"path":"api/articles/CCNP/CCNP路由 BGP.json","excerpt":null,"covers":["https://cdn.nlark.com/yuque/0/2024/jpeg/44908083/1730806229082-7508981d-6da2-4ef1-a7a8-12d8b9d550a9.jpeg","https://cdn.nlark.com/yuque/0/2024/png/44908083/1730807035348-b0a84008-40e6-4ca5-b299-e9f24f59896e.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1730809493082-98e0e6ca-f4f0-4d60-921c-277b67c3c35c.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1730892076962-e019b9cc-49c5-4659-b378-ac6690db7cfa.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1730892484804-5d4f1364-9a3c-4165-bd3e-40e75f989e0c.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1730894784939-f4d16b2c-c930-4ab1-a48c-c47743e91c9d.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1730894818299-aa7e1866-0994-4faa-88c4-156f792c9c65.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410361179-24230caa-4101-4214-b7b2-e36684c17565.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410490396-d8420a3c-2906-416b-944d-863e909fac07.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410691990-01881309-1058-46d1-a075-114e2b239fd1.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731411052266-03328819-94f7-4586-8077-d5e506eee364.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731411803897-0b6bf6f9-e658-48a4-a306-7a8d455526f8.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412077866-bf31be10-26e7-4487-8738-b72ccc505e38.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412193230-54295d0a-b300-4fea-bf2b-203de0f4a3e0.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412344784-f2e1be11-a76c-4738-9ecf-dc9a4e8884c9.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731413016975-73d4cf2b-a590-4d19-a73b-aeef941be1d8.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731413248307-5df17964-315e-4c31-8d2b-5b159d9bcf53.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731458979252-74a8f3c5-cb61-494c-8820-44d1f21f23cf.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731460387790-d039cfe4-b94c-44ce-a4f2-0d89f944d64a.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731460836560-e5a0cea7-a8fa-4bd1-a0d9-bbefda45b523.png","https://cdn.nlark.com/yuque/0/2024/jpeg/44908083/1731461244712-db15a1db-b381-40ae-8c8e-83d80a966bf6.jpeg","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731461667500-f2c080c5-fc71-4b5c-984c-22dcd23c405a.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1731461782082-4df50a90-5604-4b26-93cd-52ae719c6130.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733121752791-989f633a-4d0d-48dd-ac50-8335ac3782e9.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733121996017-8e7e4481-a185-40b9-85c2-3742644693c5.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122218668-609b391f-86ce-4a69-9cd4-22e981484fd5.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122395149-ba69abf1-caa8-4996-a318-f50e5741822e.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122474434-007e0670-c4db-4dd8-9b54-e9c5ded166c2.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122543075-6fe96b97-2d36-4b13-9bd8-ec7c21098471.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122792066-d45f8c40-28be-44fc-9ef2-fe1d61632c39.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122829384-9067e136-8d1b-4941-a29a-d059b397d1ce.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122859463-f2706ecb-995d-434a-adcd-fb3603038c63.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122918646-e2bfab69-bfb0-4d20-99e2-2e598f14cf10.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122964843-3d32c0ca-e4f3-4de0-9ec0-3260d8a107af.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122937086-5335bee7-7d2d-4911-b02c-c4bd1c6cdc3a.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123043302-ae7c2612-b283-4ed8-be08-c8ed67973230.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123094575-e9208cd3-efbf-46e1-92d6-728495dcb98d.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123298715-383afd98-b548-4353-bc46-54d9ee5187f6.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123415356-86bd5433-a930-4f66-a9a1-7d144b63fec7.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123497581-877d75ef-a72f-4ab8-aa0a-e4a792edcf90.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123628617-406b7486-d886-41d5-9ed5-115603b2032f.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124090787-e2d027b9-f95b-466a-b5e8-86d7bdb3805c.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124385448-cf61fcfb-a43e-4fb0-b8af-97b8e047e12d.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124481538-4caea059-33d5-4c50-89d2-305d5b25bf67.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124672973-08971d75-7687-4f0c-a733-782014d85b5c.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124846029-37b26bce-3e5b-41e6-949a-f6f5eca0889c.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124981265-f03cbe06-2d35-4141-82f4-4bc934728879.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125149714-85e3e77c-fab0-4cb2-aae7-d89f093f56c3.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125250291-e5171d9b-624d-4446-b988-3117e17dd97d.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125335491-71efe10e-6c26-4e45-afe6-6f30821e8c97.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125474298-a0ab0f1a-bc22-46f8-bce2-e8fcd77cebf0.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125724825-5fc79afd-ba57-4220-a7e3-c07cbc16d21f.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125796770-bb717766-917b-4aca-9dce-e03e43310a11.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126321432-30b4a9e2-5670-4e5c-b28e-b11d6398051b.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126749376-550e409c-c6c6-419c-8ca7-fa6ec14c3a1d.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126794524-8909f174-b61c-467b-9e8e-4a56528ab197.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127261820-c5da6b86-80e8-429d-bc1a-2a6100b878e4.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127420812-f87e5d92-541e-4e91-91ee-8da2c7342e7e.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127855820-e4b03bc3-1426-46bb-b770-6e35ac5f0b46.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733138789405-9509b338-52b2-4cd0-b7b8-716ee84b829a.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733138923248-9e3c4eb2-ccea-4481-8feb-28e80a14bd4e.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139053948-4ababdc6-fc58-4813-a03b-65e6b92fa662.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139094878-a409c072-6d0f-48f0-8f54-d88dc4810e2a.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139249267-49816366-cad0-4367-bc94-0694daae41ae.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139304799-ced25330-ed76-4b30-8385-39709a182131.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139376642-4f17a413-a0ac-4a12-b60a-b5f67e6af3da.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140109190-57da2edc-e4e2-44dd-859d-498ca74c3909.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140502948-58450af4-a6d4-4764-b425-43380d718b4b.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140292005-dd4b4b29-9070-492d-9038-64a94ac51f6e.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140660257-05943ad7-9a7c-4dab-af52-05dac354ea2b.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140718784-4731164f-0b69-4428-b4ff-cbeeaab41843.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140920126-45d22e04-6ac7-4ea2-b433-4ecf734da20a.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733141230441-a00716c4-3db4-4a6c-9fb7-535cd4ebe1d1.png","https://cdn.nlark.com/yuque/0/2024/png/44908083/1733208543904-53fea48b-83db-441b-964d-f8c27e92a6ee.png"],"content":"<link rel=\"stylesheet\" class=\"aplayer-secondary-style-marker\" href=\"\\assets\\css\\APlayer.min.css\"><script src=\"\\assets\\js\\APlayer.min.js\" class=\"aplayer-secondary-script-marker\"></script><script class=\"meting-secondary-script-marker\" src=\"\\assets\\js\\Meting.min.js\"></script><meta name=\"referrer\" content=\"no-referrer\">\n\n<h2 id=\"BGP概述\"><a href=\"#BGP概述\" class=\"headerlink\" title=\"BGP概述\"></a>BGP概述</h2><ul>\n<li>BGP为BorderGateway Protgcol边界网关路由协议(路径矢量)</li>\n<li>主要作用是在AS之间传递路由信息</li>\n<li>目前BGR有4个版本:V1、V2、V4、V4+(即MBGP)</li>\n<li>企业连接到SP<ul>\n<li>连接到两家或是多家ISP，提供链路的可靠性，连接方式如下</li>\n<li>1.Single homed单宿:只连接到一家ISP且没有冗余链路</li>\n<li>2.Dualhomed双宿:只连接到一家ISP，使用两条链路来提供冗余</li>\n<li>3.Multihomed多宿:连接到多家ISP</li>\n<li>4.DualMultihomed双多宿:连接到多家ISP，同时使用两条链路</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"使用BGP的三大理由\"><a href=\"#使用BGP的三大理由\" class=\"headerlink\" title=\"使用BGP的三大理由\"></a>使用BGP的三大理由</h2><ul>\n<li>大量路由需要承载，IGP只能容纳千条，而BGP可以容纳上万</li>\n<li>支撑MPLS&#x2F;VPN的应用，传递客户VPN路由</li>\n<li>策略能力强，可以很好的实现路由决策与数据控制</li>\n</ul>\n<h2 id=\"IGP具有以下某些特性或者全部特性\"><a href=\"#IGP具有以下某些特性或者全部特性\" class=\"headerlink\" title=\"IGP具有以下某些特性或者全部特性\"></a>IGP具有以下某些特性或者全部特性</h2><ul>\n<li>执行拓扑发现</li>\n<li>尽力完成快速收敛</li>\n<li>需要周期性的更新来确保路由选择信息的精准性</li>\n<li>受同一个管理机构的控制</li>\n<li>采取共同的路由选择策略</li>\n<li>提供了优先的策略控制能力</li>\n</ul>\n<h2 id=\"关于BGP\"><a href=\"#关于BGP\" class=\"headerlink\" title=\"关于BGP\"></a>关于BGP</h2><ul>\n<li>AS:autonomoussystem自治系统，指的是在同一个组织管理下使用相同策略的设备的集合</li>\n<li>不同AS通过AS号区分，AS号取值范围1-65535，其中64512-65535是私有AS号。IANA负责AS号的分发。</li>\n<li>中国电信163 AS号:4134</li>\n<li>中国电信CN2 AS号:4809 </li>\n<li>中国网通 AS号:9929</li>\n</ul>\n<h2 id=\"BGP的矢量特征\"><a href=\"#BGP的矢量特征\" class=\"headerlink\" title=\"BGP的矢量特征\"></a>BGP的矢量特征</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/jpeg/44908083/1730806229082-7508981d-6da2-4ef1-a7a8-12d8b9d550a9.jpeg\"></p>\n<ul>\n<li>路径矢量信息中包含一个BGP自治系统列表</li>\n<li>BGP路由器不接受路径列表中包含其AS号的路由更新，是<strong>无环路</strong>的</li>\n<li>BGP支持对BGP自治系统路径应用路由策略</li>\n<li>BGP路由器只能将其使用的路由通告给邻接自治系统中的对等体</li>\n</ul>\n<h2 id=\"BGP特征\"><a href=\"#BGP特征\" class=\"headerlink\" title=\"BGP特征\"></a>BGP特征</h2><ul>\n<li>BGP使用TCP为输出层协议，TCP端口号为179</li>\n<li>BGP路由器之间建立TCP连接，这些路由器称为BGP对等体也叫BGP邻居：**<font style=\"color:#DF2A3F;\">EBGP、IBGP</font>**</li>\n<li>对等体之间交换整个BGP路由表</li>\n<li>BGP路由器只发送增量更新或者触发更新（不会周期性更新）</li>\n<li>具有丰富的路径属性</li>\n<li>BGP通告成千上万的路由，可采用TCP滑动窗口的机制，停止并等待确认前，可以发送65576个字节</li>\n</ul>\n<h2 id=\"BGP-packets\"><a href=\"#BGP-packets\" class=\"headerlink\" title=\"BGP packets\"></a>BGP packets</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730807035348-b0a84008-40e6-4ca5-b299-e9f24f59896e.png\"></p>\n<h3 id=\"报文类型\"><a href=\"#报文类型\" class=\"headerlink\" title=\"报文类型\"></a>报文类型</h3><table>\n<thead>\n<tr>\n<th>报文名称</th>\n<th>作用是什么</th>\n<th>什么时候发包</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OPEN</td>\n<td>协商BGP邻居的各项参数，建立邻居关系</td>\n<td>通过TCP建立BGP连接，发送open报文</td>\n</tr>\n<tr>\n<td>UPDATE</td>\n<td>进行路由信息的交换</td>\n<td>连接建立后，有路由需要发送或路由变化时，发送UPDATE通告对端路由信息</td>\n</tr>\n<tr>\n<td>NOTIFICATION</td>\n<td>报告错误，终止邻居关系</td>\n<td>当BGP在运行时发现错误时，要发送NOTIFICATION报文通报BGP对端</td>\n</tr>\n<tr>\n<td>KEEPALIVE</td>\n<td>维持邻居关系</td>\n<td>定时发送KEEPALIVE报文以保持BGP邻居关系的有效性</td>\n</tr>\n<tr>\n<td>Route-refresh</td>\n<td>为保证网络稳定，触发更新路由的机制</td>\n<td>当路由策略发生变化时，触发请求邻居重新通告路由</td>\n</tr>\n</tbody></table>\n<h2 id=\"BGP的有限状态机\"><a href=\"#BGP的有限状态机\" class=\"headerlink\" title=\"BGP的有限状态机\"></a>BGP的有限状态机</h2><table>\n<thead>\n<tr>\n<th>Peer状态名称</th>\n<th>发什么包</th>\n<th>在做什么</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Idle</td>\n<td>尝试建立TCP连接</td>\n<td>准备开始TCP的连接并监视远程peer启动TCP连接，启用BGP时，要准备足够的资源</td>\n</tr>\n<tr>\n<td>Connect</td>\n<td>发TCP包</td>\n<td>正在进行TCP连接，等待完成中，认证都在TCP建立期间完成的。如果TCP连接不上则进入Active状态，反复尝试连接</td>\n</tr>\n<tr>\n<td>Active</td>\n<td>发TCP包</td>\n<td>TCP连接没建立成功，反复尝试TCP连接</td>\n</tr>\n<tr>\n<td>OpenSent</td>\n<td>发Open包</td>\n<td>TCP连接建立已经成功，开始发送Open包，Open包携带参数协商对等体的建立</td>\n</tr>\n<tr>\n<td>OpenConfim</td>\n<td>发Keepalive包</td>\n<td>参数、能力特性协商成功，开始自己发送Keepalive包</td>\n</tr>\n<tr>\n<td>Established</td>\n<td>发Update包</td>\n<td>已经收到对方的Keepalive包，双方能力特性一致，开始使用Update通告路由信息</td>\n</tr>\n</tbody></table>\n<h2 id=\"BGP-Peer\"><a href=\"#BGP-Peer\" class=\"headerlink\" title=\"BGP Peer\"></a>BGP Peer</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730809493082-98e0e6ca-f4f0-4d60-921c-277b67c3c35c.png\"></p>\n<ul>\n<li>运行BGP的路由器被称为BGP speaker</li>\n<li>BGP对等体也叫BGP邻居，建立基于TCP的关系</li>\n<li>EBGP：BGP位于不同自治相同的路由器之间，称为EBGP</li>\n<li>建立EBGP邻接关系，必须满足三个条件<ul>\n<li>EBGP之间自治系统号不同</li>\n<li>定义邻居建立TCP会话</li>\n<li>neighbor中指定的IP地址要可达</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"中转AS中的IBGP路由传递\"><a href=\"#中转AS中的IBGP路由传递\" class=\"headerlink\" title=\"中转AS中的IBGP路由传递\"></a>中转AS中的IBGP路由传递</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730892076962-e019b9cc-49c5-4659-b378-ac6690db7cfa.png\"></p>\n<h3 id=\"全互联IBGP邻居关系\"><a href=\"#全互联IBGP邻居关系\" class=\"headerlink\" title=\"全互联IBGP邻居关系\"></a>全互联IBGP邻居关系</h3><ul>\n<li>IBGP全互联虽然能解决transit AS内的路由黑洞问题，但是却造成BGP路由器需要耗费大量资源维护大量BGP连接的新问题<ul>\n<li>路由反射器</li>\n<li>联邦</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"IBGP水平分割原则\"><a href=\"#IBGP水平分割原则\" class=\"headerlink\" title=\"IBGP水平分割原则\"></a>IBGP水平分割原则</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730892484804-5d4f1364-9a3c-4165-bd3e-40e75f989e0c.png\"></p>\n<ul>\n<li>BGP防环是通过AS_PATH实现的，而AS_PATH仅仅实在路由离开后AS才会被更改，因此再AS内，IBGP就没有EBGP的防环能力，为了防止环路的出现，BGP路由器不会将从IBGP邻居学习过来的路由再通告给自己其他IBGP邻居</li>\n<li>由于水平分割原则存在，BGP要求AS内，需保证IBGP全互联（neighbor命令 指定）</li>\n<li>（根本原因是在AS内部，AS_PATH不会改变，无法使用AS_PATH防环，因此很容易出现环路）</li>\n</ul>\n<h2 id=\"BGP路由通告规则\"><a href=\"#BGP路由通告规则\" class=\"headerlink\" title=\"BGP路由通告规则\"></a>BGP路由通告规则</h2><ul>\n<li>当存在多条路径时，BGP router只选取最优的路由（BEST）来使用（没有负载的情况下）</li>\n<li>BGP只把自己使用的路由，也就是自己认为Best的路由传递给BGP Peer</li>\n<li>BGP Speaker从EBGP获得的路由会向它所有的BGP相邻体通告（包括EBGP和IBGP）</li>\n<li>BGP Speaker从IBGP获得的路由不向它的IBGP相邻体通告（避免循环，水平分割；存在路由RR的情况下除外）</li>\n<li>BGP Speaker从IBGP获得的路由是否通告给它的EBGP Peer要视IGP和BGP同步的情况来决定</li>\n</ul>\n<h2 id=\"BGP同步\"><a href=\"#BGP同步\" class=\"headerlink\" title=\"BGP同步\"></a>BGP同步</h2><ul>\n<li>BGP同步规则指出，BGP路由器不应使用通过IBGP获悉的路由或将其通告给外部邻居，除非该路由是本地或者通过IGP获悉的</li>\n<li>思科Cisco IOS默认关闭同步</li>\n<li>同步关闭，则BGP可以将使用这样的路由，并将其通告给外部BGP邻居：从IBGP邻居那里获悉的且没有出现在本地路由表中的路由</li>\n<li>同步开启，则路由器通过IBGP获悉路由后，将等待IGP将该路由传遍整个自治系统，然后再将其通告给外部对等体</li>\n</ul>\n<h2 id=\"Tables\"><a href=\"#Tables\" class=\"headerlink\" title=\"Tables\"></a>Tables</h2><ul>\n<li>BGP邻居表：邻居列表</li>\n<li>BGP表：包含了从邻居学习的所有路由，以及到达目的网段的多个路径和属性</li>\n<li>路由表：列出了到达目的网段的最佳路径，EBGP路由AD为20，IBGP路由AD为200</li>\n</ul>\n<h2 id=\"Next-Hop\"><a href=\"#Next-Hop\" class=\"headerlink\" title=\"Next-Hop\"></a>Next-Hop</h2><ul>\n<li>BGP是AS·by-AS的路由协议，而不是router-by-router的路由协议</li>\n<li>在BGP中，next-hop并不意味着是下一台路由器，而是到达下一个AS的IP地址</li>\n<li>EBGP中，默认next-hop为发送更新的邻居路由器的IP地址</li>\n<li>IBGP中，从EBGP传来的next-hop属性在IBGP中保持不变的被传递</li>\n</ul>\n<h3 id=\"修改next-hop\"><a href=\"#修改next-hop\" class=\"headerlink\" title=\"修改next-hop\"></a>修改next-hop</h3><ul>\n<li>为了防止路由黑洞问题，R1、R2、R3建立IBGP全互联且均用各自的LOOPBACK接口建立IBGP关系</li>\n</ul>\n<h2 id=\"配置BGP\"><a href=\"#配置BGP\" class=\"headerlink\" title=\"配置BGP\"></a>配置BGP</h2><h3 id=\"基础配置\"><a href=\"#基础配置\" class=\"headerlink\" title=\"基础配置\"></a>基础配置</h3><p><code>**Router(config)# router bgp** _autonomous-system_</code></p>\n<ul>\n<li>仅仅执行router bgp不能再路由器上激活BGP，必须执行至少一个子命令才能再路由器激活BGP进程</li>\n<li>在路由器上职能配置一个BGP实例</li>\n</ul>\n<h3 id=\"指定BGP邻居及激活BGP会话\"><a href=\"#指定BGP邻居及激活BGP会话\" class=\"headerlink\" title=\"指定BGP邻居及激活BGP会话\"></a>指定BGP邻居及激活BGP会话</h3><p><code>Router(config-router)# neighbor &#123;ip-address | peer-group-name &#125; remote-as autonomous-system</code></p>\n<ul>\n<li>邻居指定的ip地址必须路由可达</li>\n<li>BGP路由都需手工指定，不能像IGP那样通过协议自动发现</li>\n<li>AS决定与邻居建立的是EBGP还是IBGP会话</li>\n</ul>\n<h3 id=\"指定BGP将通告的网络\"><a href=\"#指定BGP将通告的网络\" class=\"headerlink\" title=\"指定BGP将通告的网络\"></a>指定BGP将通告的网络</h3><p><code>Router(config-router)#network network-number [mask network-mask] [route-map map-tag]</code></p>\n<ul>\n<li>network命今与IGP不同，BGP命令network为通告哪些IP路由进BGP进程，而不是在接口上启用BGP </li>\n<li>network支持无类前缀，前缀必须与路由表中的条目完全匹配</li>\n<li>如果不指定mask，只通告主类网络号，而且仅当主类网络中至少有一个子网出现在IP路由表中，BGP才会将该主类网络作为一条BGP路由通告</li>\n<li>指定了mask，则仅当路由选择表中有与该网络完全匹配的条目时才被通告出去</li>\n</ul>\n<h3 id=\"BGP同步-1\"><a href=\"#BGP同步-1\" class=\"headerlink\" title=\"BGP同步\"></a>BGP同步</h3><p><code>Router(config-router)# no synchronization</code></p>\n<ul>\n<li>关闭同步(默认关闭)</li>\n</ul>\n<p><code>Router(config-router)# synchronization</code></p>\n<ul>\n<li>开启同步</li>\n</ul>\n<h3 id=\"BGP-router-id\"><a href=\"#BGP-router-id\" class=\"headerlink\" title=\"BGP router-id\"></a>BGP router-id</h3><p><code>Router(config-router)# bgp router-id x.x.x.x</code></p>\n<ul>\n<li>手工设置BGP routerlD</li>\n</ul>\n<h3 id=\"示例1\"><a href=\"#示例1\" class=\"headerlink\" title=\"示例1\"></a>示例1</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730894784939-f4d16b2c-c930-4ab1-a48c-c47743e91c9d.png\"></p>\n<h3 id=\"指定更新源\"><a href=\"#指定更新源\" class=\"headerlink\" title=\"指定更新源\"></a>指定更新源</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730894818299-aa7e1866-0994-4faa-88c4-156f792c9c65.png\"></p>\n<h3 id=\"BGP身份验证\"><a href=\"#BGP身份验证\" class=\"headerlink\" title=\"BGP身份验证\"></a>BGP身份验证</h3><p>Router(config-router)# neighbor {ip-address | peer-group-name} password string</p>\n<ul>\n<li>BGP支持MD5邻居身份验证</li>\n<li>启用身份验证后，将对通过的对等体之间的TCP连接传输所有的数据等进行验证</li>\n<li>认证都是在TCP建立连接的时候完成的</li>\n</ul>\n<h2 id=\"维护BGP\"><a href=\"#维护BGP\" class=\"headerlink\" title=\"维护BGP\"></a>维护BGP</h2><ul>\n<li>重置BGP会话</li>\n<li>将新策略应用于所有路由，必须触发一个更新</li>\n</ul>\n<h3 id=\"三种触发更新的方式\"><a href=\"#三种触发更新的方式\" class=\"headerlink\" title=\"三种触发更新的方式\"></a>三种触发更新的方式</h3><ul>\n<li>硬重置</li>\n<li>软重置</li>\n<li>路由刷新</li>\n</ul>\n<h3 id=\"硬重置\"><a href=\"#硬重置\" class=\"headerlink\" title=\"硬重置\"></a>硬重置</h3><ul>\n<li>断开相应TCP连接，通过这些会话收到的所有信息都将失效，并从BGP中删除</li>\n<li>（不建议优先使用硬路由，谨慎！这将删除数据，请三思而后行！！！！）<ul>\n<li><code>clear ip bgp &#123;neighbor-address&#125;</code></li>\n<li><code>clear ip bgp *</code></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"软重置\"><a href=\"#软重置\" class=\"headerlink\" title=\"软重置\"></a>软重置</h3><ul>\n<li>不拆除并重建TCP或者BGP连接，而是仅出发更新操作以便让新的路由策略生效</li>\n<li>软重置可以仅由于出站或入站策略，也可同时用于出入站策略</li>\n</ul>\n<h4 id=\"出站软重置\"><a href=\"#出站软重置\" class=\"headerlink\" title=\"出站软重置\"></a>出站软重置</h4><ul>\n<li>不会拆除TCP连接，不会重置BGP会话，仅促发更新操作以便让新的路由策略生效（发送update消息）</li>\n<li>需要修改出站策略时，建议使用该命令</li>\n<li><code>clear ip bgp soft out</code></li>\n</ul>\n<h4 id=\"入站软重置\"><a href=\"#入站软重置\" class=\"headerlink\" title=\"入站软重置\"></a>入站软重置</h4><ul>\n<li>本地发送route-refresh给所有的BGP邻居</li>\n<li><code>clear ip bgp soft in</code></li>\n</ul>\n<p>注：CISCOIOS 12.1开始全面支持入站路由的动态软重配置，但在之前的版本在使用入站软重配置之前必须首先在BGP进程中增加如下配置:neighbor x.x.x.x soft-reconfiguration inbound然后再使用clear ip bgp soft in命令这条命令会将x.x.x.x邻居发送过来的BGP路由存储在内存中，当配置入站软重置后，路由器不再向邻居发送更新请求，而是直接在内存中存储的路由中执行新配置的入站策略，以此来防止触发大批量的路由更新而造成资源的浪费，但是这种操作仍会耗费内存，因此在使用的时候要非常慎重。</p>\n<h2 id=\"BGP属性\"><a href=\"#BGP属性\" class=\"headerlink\" title=\"BGP属性\"></a>BGP属性</h2><table>\n<thead>\n<tr>\n<th>公认属性<br>（Well-known）</th>\n<th>公认必遵<br>（Well-known mandatory）</th>\n<th>BGP 必须都能识别，且在更新消息必须包含</th>\n<th>Origin<br>AS-Path<br>Next hop</th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td>公认自决<br>（Well-known discretionary）</td>\n<td>BGP 必须都能识别，更新消息可包含可不包含</td>\n<td>Local-Preference<br>ATOMIC_Aggregate</td>\n</tr>\n<tr>\n<td>可选属性<br>（Optional）</td>\n<td>可选传递<br>（Optional transitive）</td>\n<td>可以不支持该属性，但即使不支持也应当接受包含该属性的路由并传递给其他邻居</td>\n<td>Community<br>Aggregator</td>\n</tr>\n<tr>\n<td></td>\n<td>可选非传递<br>（Opinional non-transitive）</td>\n<td>可以不支持该属性，不识别的BGP进程可以忽略包含这个属性的更新消息，并且不传递给其他BGP邻居</td>\n<td>MED<br>Originator_ID<br>Cluster_list<br>*Weight</td>\n</tr>\n</tbody></table>\n<h2 id=\"WEIGHT\"><a href=\"#WEIGHT\" class=\"headerlink\" title=\"WEIGHT\"></a>WEIGHT</h2><ul>\n<li>在路由器本地配置，只提供本地路由策略，不会传播给任何BGP邻居</li>\n<li>范围：0~65535；越大越优先</li>\n<li>路由器本地始发的路径默认权重是32768，从其他BGP邻居学到的为0</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410361179-24230caa-4101-4214-b7b2-e36684c17565.png\"></p>\n<h2 id=\"LOCAL-PREFERENCE\"><a href=\"#LOCAL-PREFERENCE\" class=\"headerlink\" title=\"LOCAL PREFERENCE\"></a>LOCAL PREFERENCE</h2><ul>\n<li><strong><font style=\"color:#DF2A3F;\">公认自由决定属性</font></strong></li>\n<li>告诉AS中的路由器，哪条路径是离开AS的首选路径</li>\n<li>LP越高路径越优</li>\n<li>只发送给IBGP邻居，而不能传给EBGP邻居</li>\n<li>默认本地优先级为100</li>\n<li><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410490396-d8420a3c-2906-416b-944d-863e909fac07.png\"></li>\n</ul>\n<h2 id=\"AS-Path（公认强制属性）\"><a href=\"#AS-Path（公认强制属性）\" class=\"headerlink\" title=\"AS-Path（公认强制属性）\"></a>AS-Path（公认强制属性）</h2><ul>\n<li>是前往目标网络的路由经过的自治系统号列表，通告该路由的自治系统号位于列表末尾</li>\n<li>作用：确认无环，通告时给EBGP时会加上自己的AS号；通告给IBGP时不修改AS-Path</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410691990-01881309-1058-46d1-a075-114e2b239fd1.png\"></p>\n<h3 id=\"四种类型\"><a href=\"#四种类型\" class=\"headerlink\" title=\"四种类型\"></a>四种类型</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731411052266-03328819-94f7-4586-8077-d5e506eee364.png\"></p>\n<ul>\n<li>**<font style=\"color:#DF2A3F;\">AS_SET</font>**：一个去往特定目的地所经路径上的无序AS列表</li>\n<li>**<font style=\"color:#DF2A3F;\">AS_SEQENCE</font>**：一个有序的AS号列表</li>\n<li>**<font style=\"color:#DF2A3F;\">AS_CONFED_SEQUENCE</font>**：一个去往特地目的地所经路径上的有序AS号列表，其用法与AS_SEQENCE完全一样，区别于该列表的AS号属于本地联邦中的AS</li>\n<li>**<font style=\"color:#DF2A3F;\">AS_CONFED_SET</font>**：一个去往特定目的地上的无序AS号列表，其用法与AS_SET一样，区别在于列表中的AS号属于本地联邦中的AA</li>\n</ul>\n<h2 id=\"Origin（公认强制属性）\"><a href=\"#Origin（公认强制属性）\" class=\"headerlink\" title=\"Origin（公认强制属性）\"></a>Origin（公认强制属性）</h2><ul>\n<li>标识路由的起源，有下列三种可能：<ul>\n<li>i\t通过BGP network，也就是起源于IGP，因为BGP network必须保证该网络在路由表中</li>\n<li>e\t是由EGP这种早期协议重发布而来</li>\n<li>？\tIncomplete，从其他渠道学习到的，路由来源不完全（确认该路由来源的信息不完全）。（重发布的路由）</li>\n</ul>\n</li>\n<li>路由优选顺序：lowest origin code（IGP&gt;EGP&gt;Incomplete）</li>\n</ul>\n<h2 id=\"MED（可选非传递属性）\"><a href=\"#MED（可选非传递属性）\" class=\"headerlink\" title=\"MED（可选非传递属性）\"></a>MED（可选非传递属性）</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731411803897-0b6bf6f9-e658-48a4-a306-7a8d455526f8.png\"></p>\n<ul>\n<li>是一种度量值，用于外部邻居指出进入AS的首选路径，即当入口有多个时，自治系统可以使用MED动态的影响其他AS如何选择进入路径</li>\n<li>度量值越小路径越优</li>\n<li>MED是在AS之间切换，MED发送给EBGP对等体。这些路由器在AS内传播MED，不传递给下一个AS</li>\n<li>默认情况下，仅当路径来自同一个AS中的不同EBGP邻居时，路由器才比较他们的MED属性</li>\n<li>MED影响进入AS的数据流:LP影响离开AS的数据流</li>\n</ul>\n<h3 id=\"比较原则及配置注意事项\"><a href=\"#比较原则及配置注意事项\" class=\"headerlink\" title=\"比较原则及配置注意事项\"></a>比较原则及配置注意事项</h3><ul>\n<li>本地在将一条BGP路由通告给EBGP Peer时，是否携带MED值,需要根据以下条件进行判断(不对EBGP Peer使用Route-map的情况下)<ul>\n<li>如果该BGP路由是本地始发(network或redistribute)的,则携带MED值发送给EBGP Peer(如果MED为空,则设置为0)</li>\n<li>如果该BGP路由是从其他BGP Peer学习过来的，那么将该路由通告给EBGPPeer时不携带MED</li>\n</ul>\n</li>\n<li>本地在将一条BGP路由通告给IBGPPeer时，一定会携带MED值<ul>\n<li>如果接收或产生的路由的MED为空,那么在向IBGP Peer通告时,将MED设置为0</li>\n</ul>\n</li>\n<li>总结1、2两点就是MED在IBGP之间传递没有问题(不会丢失)，但是在EBGP之间传递要看路由是否起源于自己。</li>\n</ul>\n<h2 id=\"NEXT-HOP（公认强制属性）2\"><a href=\"#NEXT-HOP（公认强制属性）2\" class=\"headerlink\" title=\"NEXT_HOP（公认强制属性）2\"></a>NEXT_HOP（公认强制属性）2</h2><ul>\n<li>如果路由传递自EBGP peer</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412077866-bf31be10-26e7-4487-8738-b72ccc505e38.png\"></p>\n<ul>\n<li>如果路由传递自IBGP邻居，并描述的是AS外的目的地</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412193230-54295d0a-b300-4fea-bf2b-203de0f4a3e0.png\"></p>\n<ul>\n<li>如果路由传递自IBGP邻居，并由AS内BGP路由器引入</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412344784-f2e1be11-a76c-4738-9ecf-dc9a4e8884c9.png\"></p>\n<p>Tips：如果IBGP peer使用network或重发布的方式引入IGP路由，那么通告者将使用这些路由的IGP下一跳作为NH；如果这些路由是该IBGP peer配置的BGP汇总路由，则NH为其更新源IP。</p>\n<h3 id=\"On-Shared-Media\"><a href=\"#On-Shared-Media\" class=\"headerlink\" title=\"On Shared Media\"></a>On Shared Media</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731413016975-73d4cf2b-a590-4d19-a73b-aeef941be1d8.png\"></p>\n<ul>\n<li>RouterB将路由100.100.100.0&#x2F;24传递给A，NEXT_HOP为10.1.123.2</li>\n<li>RouterA将路由100.100.100.0&#x2F;24传递给C，此时NEXT_HOP保持不变</li>\n<li>如果路由器收到某条BGP路由，该路由的NEXT_HOP地址值与EBGP邻居(更新对象)同属一个网段，那么该条路由的NEXTHOP地址将保持不变并传递给它的BGP邻居</li>\n</ul>\n<h3 id=\"On-NBMA\"><a href=\"#On-NBMA\" class=\"headerlink\" title=\"On NBMA\"></a>On NBMA</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731413248307-5df17964-315e-4c31-8d2b-5b159d9bcf53.png\"></p>\n<ul>\n<li>如果中间的多路访问不是Ethernet，而是帧中继（NBMA）呢？</li>\n</ul>\n<h2 id=\"COMMUNITY\"><a href=\"#COMMUNITY\" class=\"headerlink\" title=\"COMMUNITY\"></a>COMMUNITY</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731458979252-74a8f3c5-cb61-494c-8820-44d1f21f23cf.png\"></p>\n<ul>\n<li>可选传递属性</li>\n<li>一种标记，用于简化路由策略的执行</li>\n<li>可以将某些路由分配一个特定的COMMUNITY属性，之后就可以基于COMMUNITY值而不是每条路由进行BGP属性的设置了</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731460387790-d039cfe4-b94c-44ce-a4f2-0d89f944d64a.png\"></p>\n<h3 id=\"几个众所周知的值\"><a href=\"#几个众所周知的值\" class=\"headerlink\" title=\"几个众所周知的值\"></a>几个众所周知的值</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">set community ?</span><br><span class=\"line\">&lt;1-4294967295&gt;\tcommunity number</span><br><span class=\"line\">aa:nn\t\t\t\t\t\tcommunity number in aa:nn format</span><br><span class=\"line\">additive\t\t\t\tAdd to the existing community</span><br><span class=\"line\">internet\t\t\t\tInternet (well-known community)</span><br><span class=\"line\">local-AS\t\t\t\tDo not send outside local AS (well-known community)</span><br><span class=\"line\">no-advertise\t\tDo not advertise to any peer (well-known community)</span><br><span class=\"line\">no-export\t\t\t\tDo not export to next AS (well-known community)</span><br><span class=\"line\">none\t\t\t\t\t\tNo community attribute</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>Route</strong></p>\n<p>Community&#x3D;no-adv</p>\n<p>R2不会将该路由再通告给任何BGP peer</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731460836560-e5a0cea7-a8fa-4bd1-a0d9-bbefda45b523.png\"></p>\n<h2 id=\"Atomi-Aggregate及aggregator\"><a href=\"#Atomi-Aggregate及aggregator\" class=\"headerlink\" title=\"Atomi_Aggregate及aggregator\"></a>Atomi_Aggregate及aggregator</h2><p>172.16.0.0&#x2F;16</p>\n<p>汇总路由丢失明确路由的路径属性</p>\n<p>需要给下游邻居告警，并提示“汇总点”及汇总地AS</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/jpeg/44908083/1731461244712-db15a1db-b381-40ae-8c8e-83d80a966bf6.jpeg\"></p>\n<p><code>aggregate-address 172.16.0.0 255.255.0.0 summary-only</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R4# show ip bgp 172.16.0.0</span><br><span class=\"line\">BGP routing table entry for 172.16.0.0/16, version 4</span><br><span class=\"line\">Paths:(1 available, best #1, table Default-lP-Routing-Table)</span><br><span class=\"line\">Flag:0x820</span><br><span class=\"line\">Not advertised to any peer</span><br><span class=\"line\">300,(aggregated by 300 3.3.3.3)</span><br><span class=\"line\">10.1.34.3 from 10.1.34.3 (3.3.3.3)</span><br><span class=\"line\">Origin lGP, metric 0, localpref 100, valid, external,atomic-aggregate, best</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"报文案例\"><a href=\"#报文案例\" class=\"headerlink\" title=\"报文案例\"></a>报文案例</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731461667500-f2c080c5-fc71-4b5c-984c-22dcd23c405a.png\"></p>\n<h2 id=\"BGP自动汇总\"><a href=\"#BGP自动汇总\" class=\"headerlink\" title=\"BGP自动汇总\"></a>BGP自动汇总</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731461782082-4df50a90-5604-4b26-93cd-52ae719c6130.png\"></p>\n<ul>\n<li>若R1开启auto-summary，并用重发布直连的方式引入1.1.1.0&#x2F;24，则该子网会被汇总</li>\n<li>若R1开启auto-summary,且network1.1.1.0 mask 255.255.255.0，则仍以明细更新</li>\n<li>若R1开启auto-summary,且network1.0.0.0 mask 255.0.0.0,则该子网会被汇总</li>\n<li>上面这条network等同于network 1.0.0.0(network的有类宣告)</li>\n</ul>\n<p><strong><font style=\"color:#DF2A3F;\">因此BGP自动汇总(auto-summary)只汇总重发布引入的路由，以及使用network命令有类宣告方式引入的路由。目前CISCO IOS默认关闭自动汇总。</font></strong></p>\n<h2 id=\"BGP手动汇总\"><a href=\"#BGP手动汇总\" class=\"headerlink\" title=\"BGP手动汇总\"></a><font style=\"color:#000000;\">BGP手动汇总</font></h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733121752791-989f633a-4d0d-48dd-ac50-8335ac3782e9.png\"></p>\n<ul>\n<li>可以考虑在R3上创建静态的汇总路由</li>\n</ul>\n<p><code>ip route 172.16.0.0 255.255.0.0 null0</code></p>\n<ul>\n<li>然后再将汇总路由network进BGP</li>\n<li>不推荐此方法</li>\n</ul>\n<h3 id=\"针对特定邻居取消抑制\"><a href=\"#针对特定邻居取消抑制\" class=\"headerlink\" title=\"针对特定邻居取消抑制\"></a>针对特定邻居取消抑制</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733121996017-8e7e4481-a185-40b9-85c2-3742644693c5.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access-ist 1 permit 172.16.1.0</span><br><span class=\"line\">route-map unsupp permit 10</span><br><span class=\"line\">  match ip address 11</span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\">  neighbor 10.1.35.5 unsuppress-map unsupp</span><br><span class=\"line\">  aggregate-address 172.16.0.0 255.255.0.0 as-set summary-only</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"advertise-map\"><a href=\"#advertise-map\" class=\"headerlink\" title=\"advertise-map\"></a>advertise-map</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122218668-609b391f-86ce-4a69-9cd4-22e981484fd5.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-list list1 permit 172.16.1.0/24</span><br><span class=\"line\">ip prefix-list list1 permit 172.16.2.0/24</span><br><span class=\"line\">route-map adv permit 10</span><br><span class=\"line\">  match ip address prefix-list list1</span><br><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 summary-only as-set advertise-map adv</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"attrubute-map\"><a href=\"#attrubute-map\" class=\"headerlink\" title=\"attrubute-map\"></a>attrubute-map</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122395149-ba69abf1-caa8-4996-a318-f50e5741822e.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map attr permit 10</span><br><span class=\"line\">  set ?</span><br><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 summary-only as-set attribute-map attr</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"终方案\"><a href=\"#终方案\" class=\"headerlink\" title=\"终方案\"></a>终方案</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122474434-007e0670-c4db-4dd8-9b54-e9c5ded166c2.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 summary-only as-set</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122543075-6fe96b97-2d36-4b13-9bd8-ec7c21098471.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access-list 1 permit 172.16.2.0</span><br><span class=\"line\">access-list 1 permit 172.16.11.0</span><br><span class=\"line\">route-map suppmap permit 10</span><br><span class=\"line\">  match ip address 1</span><br><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 suppress-map suppmap</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"正则表达式\"><a href=\"#正则表达式\" class=\"headerlink\" title=\"正则表达式\"></a>正则表达式</h2><ul>\n<li>正则表达式（regular expresion）是按照一定的模板来匹配字符串的公式。</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122792066-d45f8c40-28be-44fc-9ef2-fe1d61632c39.png\"></p>\n<h3 id=\"原子字符\"><a href=\"#原子字符\" class=\"headerlink\" title=\"原子字符\"></a>原子字符</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122829384-9067e136-8d1b-4941-a29a-d059b397d1ce.png\"></p>\n<h4 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122859463-f2706ecb-995d-434a-adcd-fb3603038c63.png\"></p>\n<h3 id=\"乘法字符\"><a href=\"#乘法字符\" class=\"headerlink\" title=\"乘法字符\"></a>乘法字符</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122918646-e2bfab69-bfb0-4d20-99e2-2e598f14cf10.png\"></p>\n<h4 id=\"示例-1\"><a href=\"#示例-1\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122964843-3d32c0ca-e4f3-4de0-9ec0-3260d8a107af.png\"></p>\n<ul>\n<li>一个乘法字符可以应用于一个单字符或多个字符，如果用于多字符，需将字符串放入（ ）中</li>\n</ul>\n<h3 id=\"范围字符\"><a href=\"#范围字符\" class=\"headerlink\" title=\"范围字符\"></a>范围字符</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122937086-5335bee7-7d2d-4911-b02c-c4bd1c6cdc3a.png\"></p>\n<h4 id=\"示例-2\"><a href=\"#示例-2\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123043302-ae7c2612-b283-4ed8-be08-c8ed67973230.png\"></p>\n<h3 id=\"使用正则表达式匹配AS-PATH\"><a href=\"#使用正则表达式匹配AS-PATH\" class=\"headerlink\" title=\"使用正则表达式匹配AS_PATH\"></a>使用正则表达式匹配AS_PATH</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123094575-e9208cd3-efbf-46e1-92d6-728495dcb98d.png\"></p>\n<ul>\n<li>AS_PATH可以当作字符串并使用正则表达式进行匹配</li>\n<li>String中的 “__” 为空格，这也是一个字符，也有可能被匹配</li>\n</ul>\n<h4 id=\"示例-3\"><a href=\"#示例-3\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123298715-383afd98-b548-4353-bc46-54d9ee5187f6.png\"></p>\n<ul>\n<li>注意as-path access-list也是默认含隐拒绝所有</li>\n</ul>\n<h3 id=\"使用as-path-access-list-匹配路由\"><a href=\"#使用as-path-access-list-匹配路由\" class=\"headerlink\" title=\"使用as-path access-list 匹配路由\"></a>使用as-path access-list 匹配路由</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123415356-86bd5433-a930-4f66-a9a1-7d144b63fec7.png\"></p>\n<h4 id=\"示例1-搭配filter-list\"><a href=\"#示例1-搭配filter-list\" class=\"headerlink\" title=\"示例1 搭配filter-list\"></a>示例1 搭配filter-list</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123497581-877d75ef-a72f-4ab8-aa0a-e4a792edcf90.png\"></p>\n<ul>\n<li>在R3上可做策略</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip as-path access-ist 1deny _600$</span><br><span class=\"line\">ip as-path access-list 1 permit .*</span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\">  neighbor 10.1.23.2 filter-list 1 in</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"示例2-搭配route-map\"><a href=\"#示例2-搭配route-map\" class=\"headerlink\" title=\"示例2 搭配route-map\"></a>示例2 搭配route-map</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123628617-406b7486-d886-41d5-9ed5-115603b2032f.png\"></p>\n<ul>\n<li>R3可做策略</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip as-path access-ist 1 permit _600$</span><br><span class=\"line\">route-map setCommu permit 10</span><br><span class=\"line\">  match as-path 1</span><br><span class=\"line\">  set community no-advertise</span><br><span class=\"line\">route-map setCommu permit 10</span><br><span class=\"line\"></span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\">  neighbor 10.1.23.2 route-map setcommu in</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置命令\"><a href=\"#配置命令\" class=\"headerlink\" title=\"配置命令\"></a>配置命令</h3><p><code>Router(config)# ip as-path access-list num &#123;permit|deny&#125; regexp</code></p>\n<ul>\n<li>配置as-path access-list</li>\n</ul>\n<p><code>Router(config-router)# neighbor x.x.x.x filter-list as-path-filter &#123;inlout&#125;</code></p>\n<ul>\n<li>关联as-path access-list到filter-list，起到路由过滤作用</li>\n</ul>\n<h4 id=\"验证及查看\"><a href=\"#验证及查看\" class=\"headerlink\" title=\"验证及查看\"></a>验证及查看</h4><p><code>Router# show ip as-path-access-list</code></p>\n<ul>\n<li>查看配置的 as-path access-list</li>\n</ul>\n<p><code>Router# show ip bgp regexp xx</code></p>\n<ul>\n<li>显示BGP表中所有被该正则表达式匹配上的路由，这是一个非常不错的工具</li>\n</ul>\n<p><code>Router# show ip bgp filter-list access-list-num</code></p>\n<ul>\n<li>显示BGP表中所有被该filter-list匹配的路由</li>\n</ul>\n<h2 id=\"通告community操控路由\"><a href=\"#通告community操控路由\" class=\"headerlink\" title=\"通告community操控路由\"></a>通告community操控路由</h2><h3 id=\"BGP-Communities\"><a href=\"#BGP-Communities\" class=\"headerlink\" title=\"BGP Communities\"></a>BGP Communities</h3><ul>\n<li>BGP communities是一种路由标记方法，用于确保路由过滤和选择的连续性</li>\n<li>可选传递属性，不支持该属性的BGP router原封不动的将community值传递给下游BGP邻居</li>\n</ul>\n<h3 id=\"Community\"><a href=\"#Community\" class=\"headerlink\" title=\"Community\"></a>Community</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124090787-e2d027b9-f95b-466a-b5e8-86d7bdb3805c.png\"></p>\n<ul>\n<li>使用全局配置命令切换：</li>\n</ul>\n<p><code>ip bgp-community new-format</code></p>\n<h3 id=\"BGP路径操纵\"><a href=\"#BGP路径操纵\" class=\"headerlink\" title=\"BGP路径操纵\"></a>BGP路径操纵</h3><h4 id=\"设置Community\"><a href=\"#设置Community\" class=\"headerlink\" title=\"设置Community\"></a>设置Community</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">set community ?</span><br><span class=\"line\">&lt;1-4294967295&gt;\t\tcommunity number</span><br><span class=\"line\">aa:nn\t\t\t\t\t\t\tcommunity number in aa:nn format</span><br><span class=\"line\">additive\t\t\t\t\tAdd to the existing community</span><br><span class=\"line\">internet\t\t\t\t\tInternet(well-known community)</span><br><span class=\"line\">local-AS\t\t\t\t\tDo not send outside local AS (well-known community)</span><br><span class=\"line\">no-advertise\t\t\tDo not advertise to any peer (well-known community)</span><br><span class=\"line\">no-export\t\t\t\t\tDo not export to next AS (well-known community)</span><br><span class=\"line\">none\t\t\t\t\t\t\tNo community attribute</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总所周知的值\"><a href=\"#总所周知的值\" class=\"headerlink\" title=\"总所周知的值\"></a>总所周知的值</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124385448-cf61fcfb-a43e-4fb0-b8af-97b8e047e12d.png\"></p>\n<p><strong>Route</strong></p>\n<ul>\n<li>Community&#x3D;local-as</li>\n<li>该路由只能在本AS内传递（如果定义了联邦，则为只在联邦成员AS传递）</li>\n</ul>\n<h3 id=\"为路由前缀分配Community\"><a href=\"#为路由前缀分配Community\" class=\"headerlink\" title=\"为路由前缀分配Community\"></a>为路由前缀分配Community</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124481538-4caea059-33d5-4c50-89d2-305d5b25bf67.png\"></p>\n<ul>\n<li>R1配置如下：</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-ist 11 permit 11.11.11.0/24</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  match ip address prefix-list 11</span><br><span class=\"line\">  set community 100:11</span><br><span class=\"line\">  </span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\">  network 11.11.11.0 mask 255.255.255.0</span><br><span class=\"line\">  neighbor 10.1.12.2 remote-as 200</span><br><span class=\"line\">  neighbor 10.1.12.2 send-community</span><br><span class=\"line\">  neighbor 10.1.12.2 route-map test out</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为路由前缀分配多个Community\"><a href=\"#为路由前缀分配多个Community\" class=\"headerlink\" title=\"为路由前缀分配多个Community\"></a>为路由前缀分配多个Community</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124672973-08971d75-7687-4f0c-a733-782014d85b5c.png\"></p>\n<ul>\n<li>R2的配置如下：</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-ist 11 permit 100:11</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  match community 11</span><br><span class=\"line\">  set community no-export additive</span><br><span class=\"line\"></span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\">  neighbor 10.1.12.1 remote-as 100</span><br><span class=\"line\">  neighbor 10.1.23.3 remote-as 300</span><br><span class=\"line\">  neighbor 10.1.23.3 send-community</span><br><span class=\"line\">  neighbor 10.1.23.3 route-map test out</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为路由前缀分配多个Community（cont-）\"><a href=\"#为路由前缀分配多个Community（cont-）\" class=\"headerlink\" title=\"为路由前缀分配多个Community（cont.）\"></a>为路由前缀分配多个Community（cont.）</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124846029-37b26bce-3e5b-41e6-949a-f6f5eca0889c.png\"></p>\n<ul>\n<li>R3上查看11.11.11.0的BGP路由：</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R3#sh ip b 11.11.11.0</span><br><span class=\"line\">BGP routing table entry for 11.11.11.0/24,version 5</span><br><span class=\"line\">Paths:(1 available, best #1, table Default-P-Routing-Table, not advertised</span><br><span class=\"line\">to EBGP peer)</span><br><span class=\"line\">Flag:0x820</span><br><span class=\"line\">  Not advertised to any peer</span><br><span class=\"line\">  200 100</span><br><span class=\"line\">    10.1.23.2 from 10.1.23.2 10.1.23.2)</span><br><span class=\"line\">    Origin lGP, localpref 100, valid, external, best</span><br><span class=\"line\">    Community:100:11 no-export</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用community-list匹配团体属性\"><a href=\"#用community-list匹配团体属性\" class=\"headerlink\" title=\"用community-list匹配团体属性\"></a>用community-list匹配团体属性</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124981265-f03cbe06-2d35-4141-82f4-4bc934728879.png\"></p>\n<p><code>lp community-list 1 permit 100:11</code></p>\n<ul>\n<li>匹配。匹配community中包含100:11的路由</li>\n</ul>\n<p><code>lp community-list 1 permit 100:11 no-adv</code></p>\n<ul>\n<li>不匹配。要求100:11及no-adv两者都有才匹配成立</li>\n</ul>\n<p><code>lp community-list 1 permit 100:11</code></p>\n<p><code>Ip community-list 1 permit no-export(或将no-export换成no-adv)</code></p>\n<ul>\n<li>匹配。只要community中包含100:11或no-export</li>\n</ul>\n<h3 id=\"用community-list匹配团体属性（cont-）\"><a href=\"#用community-list匹配团体属性（cont-）\" class=\"headerlink\" title=\"用community-list匹配团体属性（cont.）\"></a>用community-list匹配团体属性（cont.）</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125149714-85e3e77c-fab0-4cb2-aae7-d89f093f56c3.png\"></p>\n<p><code>ip community-list 12 permit internet</code></p>\n<ul>\n<li>所有路由默认都属于internet</li>\n</ul>\n<h3 id=\"用community-list匹配团体属性-严格匹配\"><a href=\"#用community-list匹配团体属性-严格匹配\" class=\"headerlink\" title=\"用community-list匹配团体属性 严格匹配\"></a>用community-list匹配团体属性 严格匹配</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125250291-e5171d9b-624d-4446-b988-3117e17dd97d.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lp community-list 11 permit no-export</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">match community 11 exact-match\t\t// 严格匹配</span><br><span class=\"line\">严格匹配community属性为no-export的路由，多一点，少一点都不行</span><br><span class=\"line\"></span><br><span class=\"line\">Show lp community-ist 1 [exact-match]</span><br><span class=\"line\">查看community-list 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除某个或多个community值\"><a href=\"#删除某个或多个community值\" class=\"headerlink\" title=\"删除某个或多个community值\"></a>删除某个或多个community值</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125335491-71efe10e-6c26-4e45-afe6-6f30821e8c97.png\"></p>\n<ul>\n<li><strong>一条路由，允许携带多个community值，构成一个community列表，那么如何删除某个或者某几个community值?譬如只想删除11路由的no-export属性</strong></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-list standard del permit no-export\t\t// 匹配要删除的commu值</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  set comm-list del delete\t\t// 用这条命令删除</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除多个community值\"><a href=\"#删除多个community值\" class=\"headerlink\" title=\"删除多个community值\"></a>删除多个community值</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125474298-a0ab0f1a-bc22-46f8-bce2-e8fcd77cebf0.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-list standard del permit no-export\t\t// 用多行community-list</span><br><span class=\"line\">ip community-list standard del permit 100:11\t\t// 用多行community-list</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  set comm-list del delete</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置community-list\"><a href=\"#配置community-list\" class=\"headerlink\" title=\"配置community-list\"></a>配置community-list</h3><p><code>lp community-list 1-99 permit|deny value [value...]</code></p>\n<p>定义标准的community-list，使用internet关键字匹配任何community</p>\n<p><code>lp community-list 100-199 permit|deny regexp</code></p>\n<p>定义扩展的community-list，可使用正则表达式匹配community</p>\n<p><code>show ip community-list</code></p>\n<p>查看配置的community-list</p>\n<p><code>show ip bgp x.x.x.x</code></p>\n<p>查看BGP路由的详细信息，包括community</p>\n<h2 id=\"Prefix-list\"><a href=\"#Prefix-list\" class=\"headerlink\" title=\"Prefix-list\"></a>Prefix-list</h2><h3 id=\"配置实例\"><a href=\"#配置实例\" class=\"headerlink\" title=\"配置实例\"></a>配置实例</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125724825-5fc79afd-ba57-4220-a7e3-c07cbc16d21f.png\"></p>\n<ul>\n<li>R2上，过滤掉12.12.12.0&#x2F;24路由，其他放行</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2(config)# ip prefix-list 12 deny 12.12.12.0/24</span><br><span class=\"line\">R2(config)# ip prefix-list 12 permit 0.0.0.0/0 le 32</span><br><span class=\"line\">R2(config)# router bgp 12</span><br><span class=\"line\">R2(config-router)# neighbor 10.1.23.3 prefix-list 12 out</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"distribute-list\"><a href=\"#distribute-list\" class=\"headerlink\" title=\"distribute-list\"></a>distribute-list</h2><h3 id=\"配置实例-1\"><a href=\"#配置实例-1\" class=\"headerlink\" title=\"配置实例\"></a>配置实例</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125796770-bb717766-917b-4aca-9dce-e03e43310a11.png\"></p>\n<ul>\n<li>R2上，过滤掉12.12.12.0&#x2F;24路由，其他放行</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2(config)# access-ist 1 deny 12.12.12.0</span><br><span class=\"line\">R2(config)# access-list 1 permit any</span><br><span class=\"line\">R2(config)# router bgp 12</span><br><span class=\"line\">R2(config-router)# neighbor 10.1.23.3 distribute-list 1 out</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Route-map\"><a href=\"#Route-map\" class=\"headerlink\" title=\"Route-map\"></a>Route-map</h2><h3 id=\"可以在以下的BGP命令中使用route-map关键字\"><a href=\"#可以在以下的BGP命令中使用route-map关键字\" class=\"headerlink\" title=\"可以在以下的BGP命令中使用route-map关键字\"></a>可以在以下的BGP命令中使用route-map关键字</h3><ul>\n<li>neighbor</li>\n<li>bgp dampening</li>\n<li>network</li>\n<li>redistribute</li>\n</ul>\n<h3 id=\"可以为特定的目的在不同的命令中调用定义好的route-map\"><a href=\"#可以为特定的目的在不同的命令中调用定义好的route-map\" class=\"headerlink\" title=\"可以为特定的目的在不同的命令中调用定义好的route-map\"></a>可以为特定的目的在不同的命令中调用定义好的route-map</h3><ul>\n<li>suppress-map</li>\n<li>unsuppress-map</li>\n<li>advertise-map</li>\n<li>inject-map</li>\n<li>exist-map</li>\n<li>non-exist-map</li>\n<li>tabel-map</li>\n</ul>\n<h3 id=\"match语句能匹配\"><a href=\"#match语句能匹配\" class=\"headerlink\" title=\"match语句能匹配\"></a>match语句能匹配</h3><ul>\n<li>Access-list</li>\n<li>Ip prefix-list</li>\n<li>Ip next-hop</li>\n<li>local-preference</li>\n<li>metric</li>\n<li>Tag</li>\n<li>AS PATH</li>\n<li>BGP community</li>\n<li>IGP route-type(internal&#x2F;external)</li>\n</ul>\n<h3 id=\"set语句能设置\"><a href=\"#set语句能设置\" class=\"headerlink\" title=\"set语句能设置\"></a>set语句能设置</h3><ul>\n<li>Origin</li>\n<li>Weight</li>\n<li>BGP community</li>\n<li>LOCAL PREFERENCE</li>\n<li>MED</li>\n</ul>\n<h3 id=\"配置实例-关联network-执行策略\"><a href=\"#配置实例-关联network-执行策略\" class=\"headerlink\" title=\"配置实例 关联network 执行策略\"></a>配置实例 关联network 执行策略</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126321432-30b4a9e2-5670-4e5c-b28e-b11d6398051b.png\"></p>\n<ul>\n<li><em><strong>R1上，network引入路由时设置路径属性</strong></em></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-list 11 permit 11.11.11.0/24</span><br><span class=\"line\">ip prefix-ist 12 permit 12.12.12.0/24</span><br><span class=\"line\">route-map RP1 permit 10</span><br><span class=\"line\">  set community 100:11</span><br><span class=\"line\">route-map RP2 permit 20</span><br><span class=\"line\">  set community 100:12</span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\">  network 11.11.11.0 mask 255.255.255.0 route-map RP1</span><br><span class=\"line\">  network 12.12.12.0 mask 255.255.255.0 route-map RP2</span><br><span class=\"line\">  neighbor 10.1.12.2 send-community</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>该策略对所有BGP邻居有效</strong></li>\n</ul>\n<h3 id=\"关联neighbor，针对特定邻居执行策略\"><a href=\"#关联neighbor，针对特定邻居执行策略\" class=\"headerlink\" title=\"关联neighbor，针对特定邻居执行策略\"></a>关联neighbor，针对特定邻居执行策略</h3><p><strong>R1上，对R2传递路由时，设定MED属性值</strong></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126749376-550e409c-c6c6-419c-8ca7-fa6ec14c3a1d.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-list 11 permit 11.11.11.0/24</span><br><span class=\"line\">ip prefix-list 12 permit 12.12.12.0/24</span><br><span class=\"line\">route-map RP permit 10</span><br><span class=\"line\">  match ip address 11</span><br><span class=\"line\">  set metric 1000</span><br><span class=\"line\">route-map RP permit 20</span><br><span class=\"line\">  match ip address 12</span><br><span class=\"line\">  set metric 2000</span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\">  neighbor 10.1.12.2 route-map RP out</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置实例-重发布关联route-map\"><a href=\"#配置实例-重发布关联route-map\" class=\"headerlink\" title=\"配置实例 重发布关联route-map\"></a>配置实例 重发布关联route-map</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126794524-8909f174-b61c-467b-9e8e-4a56528ab197.png\"></p>\n<p><strong>R2上，将OSPF路由重发布进BGP</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router bgp 200</span><br><span class=\"line\">redistribute ospf 1 route-map RP match ?</span><br><span class=\"line\">neighbor 10.1.12.1 remote-as 100</span><br><span class=\"line\">no auto-summary</span><br></pre></td></tr></table></figure>\n\n<p><strong>redistribute ospf 1</strong></p>\n<ul>\n<li>默认只重发布Intra-Area及Inter-Area路由</li>\n<li>match extemnal只重发布E1及E2</li>\n<li>match external 1只重发布E1;external 2只重发布E2</li>\n<li>match nssa-external 只重发布NSSA外部路由</li>\n</ul>\n<h3 id=\"Policy-list\"><a href=\"#Policy-list\" class=\"headerlink\" title=\"Policy-list\"></a>Policy-list</h3><ul>\n<li>可预先将包含一组match语句的route-map定义成一个命令列表，这个列表称为policy-list</li>\n<li>这些policy-list可以在route-map中被调用</li>\n<li>一个policy-list就像个只包含match语句的route-map当route-map被执行，被其调用的policy-list中所包含的match语句将一并被遍历且执行match动作</li>\n<li>这是一种在大中型网络中运用、使得配置“模块化”的特性</li>\n</ul>\n<h4 id=\"特性\"><a href=\"#特性\" class=\"headerlink\" title=\"特性\"></a>特性</h4><ul>\n<li>Ipv6不支持</li>\n<li>12.0(22)S 和12.2(15)T之前的CISCOIOS版本不支持该特性，另外更老的IOS版本的路由器重启存在路由策略配置丢失的风险</li>\n<li>Policy-list中不能包含set语句，但是它被route-map调用后，该route-map中可以包含set语句</li>\n<li>Policy-list只在BGP中支持，其他的IP路由协议并不支持这个特性</li>\n</ul>\n<h4 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip policy-list as100 permit</span><br><span class=\"line\">  match as-path 1</span><br><span class=\"line\">  match community 1</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>上述命令创建一个policy-list</li>\n<li>Policy-list只能包含match语句</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map RP permit 10</span><br><span class=\"line\">  match policy-list as100</span><br><span class=\"line\">  match ip address prefix-list 100</span><br><span class=\"line\">  set local-preference 300</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>上述命令在route-map中调用定义好的policy-list</li>\n<li>一个route-map中可调用多个policy-list</li>\n</ul>\n<h2 id=\"ORF\"><a href=\"#ORF\" class=\"headerlink\" title=\"ORF\"></a>ORF</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127261820-c5da6b86-80e8-429d-bc1a-2a6100b878e4.png\"></p>\n<h3 id=\"配置-1\"><a href=\"#配置-1\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127420812-f87e5d92-541e-4e91-91ee-8da2c7342e7e.png\"></p>\n<ul>\n<li>R2的配置（sender）</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router bgp 12</span><br><span class=\"line\">  address-family ipv4 unicast</span><br><span class=\"line\">  neighbor 10.1.12.1 capability orf prefix-ist send</span><br><span class=\"line\">  neighbor 10.1.12.1 prefix-list FILTER in</span><br><span class=\"line\"></span><br><span class=\"line\">ip prefix-ist FlLTER deny 1.1.1.0/24</span><br><span class=\"line\">ip prefix-list FlLTER permit</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>R1的配置（receiver）</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router bgp 12</span><br><span class=\"line\">  address-family ipv4 unicast</span><br><span class=\"line\">  neighbor 10.1.12.2 capability orf prefix-list receive</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>注意：省去基本配置，如手工指定BGP邻居</li>\n</ul>\n<h3 id=\"一些\"><a href=\"#一些\" class=\"headerlink\" title=\"一些\"></a>一些</h3><ul>\n<li>ORF消息包含以下内容<ul>\n<li>AFl&#x2F;SAFlipv4 unicast</li>\n<li>ORF TYPE</li>\n<li>When to refresh</li>\n<li>List of ORF entries</li>\n</ul>\n</li>\n<li>ORF类型不同，ORFentries也不尽相同</li>\n<li>每种ORF类型都需要进行ORF能力的协商</li>\n</ul>\n<h2 id=\"路由拆分-BGP-Deaggregation\"><a href=\"#路由拆分-BGP-Deaggregation\" class=\"headerlink\" title=\"路由拆分 BGP Deaggregation\"></a>路由拆分 BGP Deaggregation</h2><h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127855820-e4b03bc3-1426-46bb-b770-6e35ac5f0b46.png\"></p>\n<h3 id=\"配置-2\"><a href=\"#配置-2\" class=\"headerlink\" title=\"配置\"></a>配置</h3><ul>\n<li>Conditional inject的配置如下(BGP路由选择进程模式下)</li>\n</ul>\n<p><code>bgp inject-map map1 exist-map map2 [copy attributes]</code></p>\n<ul>\n<li>上述命令的意思是当map2所匹配的汇总路由正常时，在本地BGP RIB中注入map1中定义的明细路由。</li>\n<li>当汇总路由挂掉，这条明细也就跟着消失，这就是所谓的条件注入-conditional injection。</li>\n<li>下面我们在看来一下这两个route-map的详细内容，这些是需要格外注意的。</li>\n<li>exist-map使用的route-map最少具有以下两个match语句</li>\n</ul>\n<p><code>match ip address prefix-list</code></p>\n<ul>\n<li>上面这条match语句用来匹配汇总路由</li>\n</ul>\n<p><code>match ip route-source</code></p>\n<ul>\n<li>上面这条match语句用来匹配发送该汇总路由的邻居IP。如果指定了copyattributes选项，那么被inject的明细路由会继承汇总路由的路径属性，否则明细将被当成本地生成的路由。</li>\n<li>Inject-map使用的route-map中</li>\n</ul>\n<p><code>Set ip address prefix-list</code></p>\n<ul>\n<li>上面的这条set命令用来定义将被注入到本地BGPRIB的明细路由。被注入的前缀可以使用</li>\n</ul>\n<p><code>Show ip bgpinjected-path</code></p>\n<ul>\n<li>来显示</li>\n</ul>\n<h2 id=\"路由反射器\"><a href=\"#路由反射器\" class=\"headerlink\" title=\"路由反射器\"></a>路由反射器</h2><h3 id=\"中转AS中的IBGP问题\"><a href=\"#中转AS中的IBGP问题\" class=\"headerlink\" title=\"中转AS中的IBGP问题\"></a>中转AS中的IBGP问题</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733138789405-9509b338-52b2-4cd0-b7b8-716ee84b829a.png\"></p>\n<ul>\n<li>AS内要求IBGP全互联（IBGP水平分割）</li>\n<li>BGP routers<ul>\n<li>需维护大量的TCP和BGP链接</li>\n<li>网络中充斥着BGP路由信息</li>\n</ul>\n</li>\n<li>解决方案<ul>\n<li>路由反射器</li>\n<li>BGP联邦</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"背景-1\"><a href=\"#背景-1\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733138923248-9e3c4eb2-ccea-4481-8feb-28e80a14bd4e.png\"></p>\n<ul>\n<li>因为IBGP水平分割原则，导致AS内部需要维护大量的BGP链接（要求IBGP全互联），从而影响网络性能，路由反射器可以“放宽”水平分割原则，缓解该问题</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139053948-4ababdc6-fc58-4813-a03b-65e6b92fa662.png\"></p>\n<ul>\n<li>Route Reflector</li>\n<li>Client</li>\n</ul>\n<h3 id=\"联邦内的BGP路由路径属性\"><a href=\"#联邦内的BGP路由路径属性\" class=\"headerlink\" title=\"联邦内的BGP路由路径属性\"></a>联邦内的BGP路由路径属性</h3><ul>\n<li>在联邦内部保留外部路由的NEXT_HOP属性</li>\n<li>公布给联邦的路由的MED属性在整个联邦范围内予以保留</li>\n<li>路由的LP属性在整个联邦范围内予以保留</li>\n<li>在联邦范围内，将成员AS号压入AS PATH，但不公布到联邦外，并且使用TYPE3、4的AS PATH</li>\n<li>AS PATH中的联邦成员AS号用于在联邦内部避免环路;联邦内成员AS号不参与AS PATH长度计算</li>\n</ul>\n<h3 id=\"路由反射原则\"><a href=\"#路由反射原则\" class=\"headerlink\" title=\"路由反射原则\"></a>路由反射原则</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139094878-a409c072-6d0f-48f0-8f54-d88dc4810e2a.png\"></p>\n<ul>\n<li>如果路由学习自非client IBGP对等体，则反射给所有client</li>\n<li>如果路由学习自—client，则反射给所有非client IBGP邻居和除了该client以外的所有client</li>\n<li>如果路由学习自EBGP邻居，则发送给所有的client和非client IBGP邻居</li>\n</ul>\n<h3 id=\"实例1\"><a href=\"#实例1\" class=\"headerlink\" title=\"实例1\"></a>实例1</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139249267-49816366-cad0-4367-bc94-0694daae41ae.png\"></p>\n<ul>\n<li>如果路由学习自一client，则反射给所有非client IBGP邻居和除了该client以外的所有client</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139304799-ced25330-ed76-4b30-8385-39709a182131.png\"></p>\n<ul>\n<li>如果路由学习至自client IBG对等体，则反射给所有的client</li>\n</ul>\n<h3 id=\"路由反射器下的防环\"><a href=\"#路由反射器下的防环\" class=\"headerlink\" title=\"路由反射器下的防环\"></a>路由反射器下的防环</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139376642-4f17a413-a0ac-4a12-b60a-b5f67e6af3da.png\"></p>\n<ul>\n<li>由于AS PATH属性在AS内部不会发生变化(仅当路由离开本AS才会被更新)，因此AS内才有水平分割的机制用于防止环路，而路由反射器实际上是放宽了水平分割原则，这个就会给环路带来一定的隐患，因此路由反射器需使用以下两个属性防止环路ORIGINATOR ID和CLUSTER LIST是路由反射器使用的可选非传递属性，用来防止环路。</li>\n</ul>\n<h3 id=\"Originator-ID、Cluster-list\"><a href=\"#Originator-ID、Cluster-list\" class=\"headerlink\" title=\"Originator_ID、Cluster_list\"></a>Originator_ID、Cluster_list</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140109190-57da2edc-e4e2-44dd-859d-498ca74c3909.png\"></p>\n<h4 id=\"Originator-ID\"><a href=\"#Originator-ID\" class=\"headerlink\" title=\"Originator_ID\"></a>Originator_ID</h4><ul>\n<li>每当一条路由被路由反射器反射时，该路由的始发IBGP路由器的Router-ID将会被存在路由的originator_ID属性中</li>\n<li>当一台路由器收到IBGP路由且其originatorID与该路由器的RouterID相同，则路由器忽略该条路由</li>\n<li>Originator_ID及Cluster-list属性将会影响BGP路径决策</li>\n</ul>\n<h4 id=\"Originator-ID的值\"><a href=\"#Originator-ID的值\" class=\"headerlink\" title=\"Originator_ID的值\"></a>Originator_ID的值</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140502948-58450af4-a6d4-4764-b425-43380d718b4b.png\"></p>\n<h3 id=\"路由反射原则-1\"><a href=\"#路由反射原则-1\" class=\"headerlink\" title=\"路由反射原则\"></a>路由反射原则</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140292005-dd4b4b29-9070-492d-9038-64a94ac51f6e.png\"></p>\n<ul>\n<li>如果路由学习自非client lBGP对等体，则反射给所有client</li>\n<li>如果路由学习自一client，则反射给所有非ctientIBGP邻居和除了该client以外的所有client</li>\n<li>如果路由学习自EBGP邻居，则发送给所有client和非clientIBGP邻居</li>\n</ul>\n<h3 id=\"路由反射簇\"><a href=\"#路由反射簇\" class=\"headerlink\" title=\"路由反射簇\"></a>路由反射簇</h3><ul>\n<li>路由反射簇包括反射器及其Client</li>\n<li>每一个簇都有唯一的簇ID</li>\n<li>每当一条路由被反射器反射后，该反射器(该簇)的ClusterID就会被添加至路由的Cluster list属性中</li>\n<li>每当反射器收到一条Cluster list属性已经包含该簇的ClusterID的路由时，该路由基于防环的目的将不被反射</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140660257-05943ad7-9a7c-4dab-af52-05dac354ea2b.png\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140718784-4731164f-0b69-4428-b4ff-cbeeaab41843.png\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140920126-45d22e04-6ac7-4ea2-b433-4ecf734da20a.png\"></p>\n<h3 id=\"路由反射器冗余\"><a href=\"#路由反射器冗余\" class=\"headerlink\" title=\"路由反射器冗余\"></a>路由反射器冗余</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733141230441-a00716c4-3db4-4a6c-9fb7-535cd4ebe1d1.png\"></p>\n<ul>\n<li>冗余RR增加了网络的健壮性</li>\n<li>使用Originator IDCluster_list属性来在冗余RR环境中避免路由环路。</li>\n<li>例如将两个RR 的Cluster_ID配置为一样，那么可以起到进一步的防环作用</li>\n<li>所有的RR之间建议采用IBGP全互联</li>\n<li>Client会收到来自两个RR反射的路由，如何决策 ?</li>\n</ul>\n<h3 id=\"BGP选路规则\"><a href=\"#BGP选路规则\" class=\"headerlink\" title=\"BGP选路规则\"></a>BGP选路规则</h3><ol>\n<li>优选具有最大Weight值的路由</li>\n<li>优选具有最大Local Pref值的路由</li>\n<li>优选起源于本地的路由(如本地networkaggregate或redistribute的)即下一跳是0.0.0.0(在BGP 表中,当前路由器通告的路由的下一跳为0.0.0.0)</li>\n<li>优选AS-Path最短的路由</li>\n<li>Origin(IGP &gt;EGP&gt;Incomplete )</li>\n<li>优选MED最小的路由，默认情况下仅有当所有的备选路由来自同一AS才会比较MED</li>\n<li>优选EBGP邻居发来的路由(相对于IBGP邻居学过来的)，在联邦EBGP和IBGP中首选联邦EBGP 路由</li>\n<li>优选到BGP NEXT HOP最近的邻居</li>\n<li>如果有多条来自相同相邻AS的路由并通过Maximum-paths 使多条路径可用,则将所有开销相同的路由放入Loc-RIB</li>\n<li>优选最老的EBGP路由，降低滚翻的影响(此条主要对EBGP路由起效，但是现在基本不用该条，因不确定性太大)</li>\n<li>BGP 邻居的RID越小越优先</li>\n<li>优选Cluster-List 最短的路由</li>\n<li>选择邻居ip地址(BGP的neighbor配置中的那个地址)最小的路由</li>\n</ol>\n<h2 id=\"优选MED最小的路由\"><a href=\"#优选MED最小的路由\" class=\"headerlink\" title=\"优选MED最小的路由\"></a>优选MED最小的路由</h2><h3 id=\"MED属性设置方法\"><a href=\"#MED属性设置方法\" class=\"headerlink\" title=\"MED属性设置方法\"></a>MED属性设置方法</h3><ul>\n<li>将IGP路由引入BGP时关联Route-map进行设置</li>\n<li>对BGP Peer应用IN&#x2F;OUT方向的Route-map进行设置</li>\n<li>非Route-map(自动)方式<ul>\n<li>使用network或redistribute方式将IGP路由引入BGP时,MED将继承IGP路由的Metric(直联路由及静态路由的Metric为0)</li>\n<li>使用aggregate-address方式引入路由，则MED为空</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"MED注意事项\"><a href=\"#MED注意事项\" class=\"headerlink\" title=\"MED注意事项\"></a>MED注意事项</h3><ul>\n<li>默认情况下，只比较来自同一邻居AS的BGP路由的MED值，就是说如果同一个目的地的两条路由来自不同的AS，则不进行MED值的比较。如果仍然希望比较来自不同邻接AS的路由，可使用如下命令</li>\n<li><code>bgp always-compare-med</code></li>\n<li>MED只是在直接相连的自治系统间影响业务量，而不会跨AS传递</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733208543904-53fea48b-83db-441b-964d-f8c27e92a6ee.png\"></p>\n<h2 id=\"BGP负载均衡\"><a href=\"#BGP负载均衡\" class=\"headerlink\" title=\"BGP负载均衡\"></a>BGP负载均衡</h2><ul>\n<li>当前面的8条选路原则都无法优选出最优路由时，并且在BGP进程下面配置了maximum-paths[ibgp]n,n的取值为2-6,那么将执行等价负载均衡，也就是将这些等代价的BGP路径都放进IP路由表使用，但是要注意，虽然这些路径在本地都用了，最终却只有一条BGP路径是best最优的。具备等价负载均衡条件的候选路径需满足如下条件:<ul>\n<li>必须有相同的路径属性，如weight、LP、AS PATH(不仅是长度，整个AS PATH包括AS号都要相同)、origincode、MED及IGP的Distance值</li>\n<li>每一条路径的下一跳都不相同</li>\n</ul>\n</li>\n</ul>\n<p>__</p>\n","more":"<meta name=\"referrer\" content=\"no-referrer\">\n\n<h2 id=\"BGP概述\"><a href=\"#BGP概述\" class=\"headerlink\" title=\"BGP概述\"></a>BGP概述</h2><ul>\n<li>BGP为BorderGateway Protgcol边界网关路由协议(路径矢量)</li>\n<li>主要作用是在AS之间传递路由信息</li>\n<li>目前BGR有4个版本:V1、V2、V4、V4+(即MBGP)</li>\n<li>企业连接到SP<ul>\n<li>连接到两家或是多家ISP，提供链路的可靠性，连接方式如下</li>\n<li>1.Single homed单宿:只连接到一家ISP且没有冗余链路</li>\n<li>2.Dualhomed双宿:只连接到一家ISP，使用两条链路来提供冗余</li>\n<li>3.Multihomed多宿:连接到多家ISP</li>\n<li>4.DualMultihomed双多宿:连接到多家ISP，同时使用两条链路</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"使用BGP的三大理由\"><a href=\"#使用BGP的三大理由\" class=\"headerlink\" title=\"使用BGP的三大理由\"></a>使用BGP的三大理由</h2><ul>\n<li>大量路由需要承载，IGP只能容纳千条，而BGP可以容纳上万</li>\n<li>支撑MPLS&#x2F;VPN的应用，传递客户VPN路由</li>\n<li>策略能力强，可以很好的实现路由决策与数据控制</li>\n</ul>\n<h2 id=\"IGP具有以下某些特性或者全部特性\"><a href=\"#IGP具有以下某些特性或者全部特性\" class=\"headerlink\" title=\"IGP具有以下某些特性或者全部特性\"></a>IGP具有以下某些特性或者全部特性</h2><ul>\n<li>执行拓扑发现</li>\n<li>尽力完成快速收敛</li>\n<li>需要周期性的更新来确保路由选择信息的精准性</li>\n<li>受同一个管理机构的控制</li>\n<li>采取共同的路由选择策略</li>\n<li>提供了优先的策略控制能力</li>\n</ul>\n<h2 id=\"关于BGP\"><a href=\"#关于BGP\" class=\"headerlink\" title=\"关于BGP\"></a>关于BGP</h2><ul>\n<li>AS:autonomoussystem自治系统，指的是在同一个组织管理下使用相同策略的设备的集合</li>\n<li>不同AS通过AS号区分，AS号取值范围1-65535，其中64512-65535是私有AS号。IANA负责AS号的分发。</li>\n<li>中国电信163 AS号:4134</li>\n<li>中国电信CN2 AS号:4809 </li>\n<li>中国网通 AS号:9929</li>\n</ul>\n<h2 id=\"BGP的矢量特征\"><a href=\"#BGP的矢量特征\" class=\"headerlink\" title=\"BGP的矢量特征\"></a>BGP的矢量特征</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/jpeg/44908083/1730806229082-7508981d-6da2-4ef1-a7a8-12d8b9d550a9.jpeg\"></p>\n<ul>\n<li>路径矢量信息中包含一个BGP自治系统列表</li>\n<li>BGP路由器不接受路径列表中包含其AS号的路由更新，是<strong>无环路</strong>的</li>\n<li>BGP支持对BGP自治系统路径应用路由策略</li>\n<li>BGP路由器只能将其使用的路由通告给邻接自治系统中的对等体</li>\n</ul>\n<h2 id=\"BGP特征\"><a href=\"#BGP特征\" class=\"headerlink\" title=\"BGP特征\"></a>BGP特征</h2><ul>\n<li>BGP使用TCP为输出层协议，TCP端口号为179</li>\n<li>BGP路由器之间建立TCP连接，这些路由器称为BGP对等体也叫BGP邻居：**<font style=\"color:#DF2A3F;\">EBGP、IBGP</font>**</li>\n<li>对等体之间交换整个BGP路由表</li>\n<li>BGP路由器只发送增量更新或者触发更新（不会周期性更新）</li>\n<li>具有丰富的路径属性</li>\n<li>BGP通告成千上万的路由，可采用TCP滑动窗口的机制，停止并等待确认前，可以发送65576个字节</li>\n</ul>\n<h2 id=\"BGP-packets\"><a href=\"#BGP-packets\" class=\"headerlink\" title=\"BGP packets\"></a>BGP packets</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730807035348-b0a84008-40e6-4ca5-b299-e9f24f59896e.png\"></p>\n<h3 id=\"报文类型\"><a href=\"#报文类型\" class=\"headerlink\" title=\"报文类型\"></a>报文类型</h3><table>\n<thead>\n<tr>\n<th>报文名称</th>\n<th>作用是什么</th>\n<th>什么时候发包</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OPEN</td>\n<td>协商BGP邻居的各项参数，建立邻居关系</td>\n<td>通过TCP建立BGP连接，发送open报文</td>\n</tr>\n<tr>\n<td>UPDATE</td>\n<td>进行路由信息的交换</td>\n<td>连接建立后，有路由需要发送或路由变化时，发送UPDATE通告对端路由信息</td>\n</tr>\n<tr>\n<td>NOTIFICATION</td>\n<td>报告错误，终止邻居关系</td>\n<td>当BGP在运行时发现错误时，要发送NOTIFICATION报文通报BGP对端</td>\n</tr>\n<tr>\n<td>KEEPALIVE</td>\n<td>维持邻居关系</td>\n<td>定时发送KEEPALIVE报文以保持BGP邻居关系的有效性</td>\n</tr>\n<tr>\n<td>Route-refresh</td>\n<td>为保证网络稳定，触发更新路由的机制</td>\n<td>当路由策略发生变化时，触发请求邻居重新通告路由</td>\n</tr>\n</tbody></table>\n<h2 id=\"BGP的有限状态机\"><a href=\"#BGP的有限状态机\" class=\"headerlink\" title=\"BGP的有限状态机\"></a>BGP的有限状态机</h2><table>\n<thead>\n<tr>\n<th>Peer状态名称</th>\n<th>发什么包</th>\n<th>在做什么</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Idle</td>\n<td>尝试建立TCP连接</td>\n<td>准备开始TCP的连接并监视远程peer启动TCP连接，启用BGP时，要准备足够的资源</td>\n</tr>\n<tr>\n<td>Connect</td>\n<td>发TCP包</td>\n<td>正在进行TCP连接，等待完成中，认证都在TCP建立期间完成的。如果TCP连接不上则进入Active状态，反复尝试连接</td>\n</tr>\n<tr>\n<td>Active</td>\n<td>发TCP包</td>\n<td>TCP连接没建立成功，反复尝试TCP连接</td>\n</tr>\n<tr>\n<td>OpenSent</td>\n<td>发Open包</td>\n<td>TCP连接建立已经成功，开始发送Open包，Open包携带参数协商对等体的建立</td>\n</tr>\n<tr>\n<td>OpenConfim</td>\n<td>发Keepalive包</td>\n<td>参数、能力特性协商成功，开始自己发送Keepalive包</td>\n</tr>\n<tr>\n<td>Established</td>\n<td>发Update包</td>\n<td>已经收到对方的Keepalive包，双方能力特性一致，开始使用Update通告路由信息</td>\n</tr>\n</tbody></table>\n<h2 id=\"BGP-Peer\"><a href=\"#BGP-Peer\" class=\"headerlink\" title=\"BGP Peer\"></a>BGP Peer</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730809493082-98e0e6ca-f4f0-4d60-921c-277b67c3c35c.png\"></p>\n<ul>\n<li>运行BGP的路由器被称为BGP speaker</li>\n<li>BGP对等体也叫BGP邻居，建立基于TCP的关系</li>\n<li>EBGP：BGP位于不同自治相同的路由器之间，称为EBGP</li>\n<li>建立EBGP邻接关系，必须满足三个条件<ul>\n<li>EBGP之间自治系统号不同</li>\n<li>定义邻居建立TCP会话</li>\n<li>neighbor中指定的IP地址要可达</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"中转AS中的IBGP路由传递\"><a href=\"#中转AS中的IBGP路由传递\" class=\"headerlink\" title=\"中转AS中的IBGP路由传递\"></a>中转AS中的IBGP路由传递</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730892076962-e019b9cc-49c5-4659-b378-ac6690db7cfa.png\"></p>\n<h3 id=\"全互联IBGP邻居关系\"><a href=\"#全互联IBGP邻居关系\" class=\"headerlink\" title=\"全互联IBGP邻居关系\"></a>全互联IBGP邻居关系</h3><ul>\n<li>IBGP全互联虽然能解决transit AS内的路由黑洞问题，但是却造成BGP路由器需要耗费大量资源维护大量BGP连接的新问题<ul>\n<li>路由反射器</li>\n<li>联邦</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"IBGP水平分割原则\"><a href=\"#IBGP水平分割原则\" class=\"headerlink\" title=\"IBGP水平分割原则\"></a>IBGP水平分割原则</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730892484804-5d4f1364-9a3c-4165-bd3e-40e75f989e0c.png\"></p>\n<ul>\n<li>BGP防环是通过AS_PATH实现的，而AS_PATH仅仅实在路由离开后AS才会被更改，因此再AS内，IBGP就没有EBGP的防环能力，为了防止环路的出现，BGP路由器不会将从IBGP邻居学习过来的路由再通告给自己其他IBGP邻居</li>\n<li>由于水平分割原则存在，BGP要求AS内，需保证IBGP全互联（neighbor命令 指定）</li>\n<li>（根本原因是在AS内部，AS_PATH不会改变，无法使用AS_PATH防环，因此很容易出现环路）</li>\n</ul>\n<h2 id=\"BGP路由通告规则\"><a href=\"#BGP路由通告规则\" class=\"headerlink\" title=\"BGP路由通告规则\"></a>BGP路由通告规则</h2><ul>\n<li>当存在多条路径时，BGP router只选取最优的路由（BEST）来使用（没有负载的情况下）</li>\n<li>BGP只把自己使用的路由，也就是自己认为Best的路由传递给BGP Peer</li>\n<li>BGP Speaker从EBGP获得的路由会向它所有的BGP相邻体通告（包括EBGP和IBGP）</li>\n<li>BGP Speaker从IBGP获得的路由不向它的IBGP相邻体通告（避免循环，水平分割；存在路由RR的情况下除外）</li>\n<li>BGP Speaker从IBGP获得的路由是否通告给它的EBGP Peer要视IGP和BGP同步的情况来决定</li>\n</ul>\n<h2 id=\"BGP同步\"><a href=\"#BGP同步\" class=\"headerlink\" title=\"BGP同步\"></a>BGP同步</h2><ul>\n<li>BGP同步规则指出，BGP路由器不应使用通过IBGP获悉的路由或将其通告给外部邻居，除非该路由是本地或者通过IGP获悉的</li>\n<li>思科Cisco IOS默认关闭同步</li>\n<li>同步关闭，则BGP可以将使用这样的路由，并将其通告给外部BGP邻居：从IBGP邻居那里获悉的且没有出现在本地路由表中的路由</li>\n<li>同步开启，则路由器通过IBGP获悉路由后，将等待IGP将该路由传遍整个自治系统，然后再将其通告给外部对等体</li>\n</ul>\n<h2 id=\"Tables\"><a href=\"#Tables\" class=\"headerlink\" title=\"Tables\"></a>Tables</h2><ul>\n<li>BGP邻居表：邻居列表</li>\n<li>BGP表：包含了从邻居学习的所有路由，以及到达目的网段的多个路径和属性</li>\n<li>路由表：列出了到达目的网段的最佳路径，EBGP路由AD为20，IBGP路由AD为200</li>\n</ul>\n<h2 id=\"Next-Hop\"><a href=\"#Next-Hop\" class=\"headerlink\" title=\"Next-Hop\"></a>Next-Hop</h2><ul>\n<li>BGP是AS·by-AS的路由协议，而不是router-by-router的路由协议</li>\n<li>在BGP中，next-hop并不意味着是下一台路由器，而是到达下一个AS的IP地址</li>\n<li>EBGP中，默认next-hop为发送更新的邻居路由器的IP地址</li>\n<li>IBGP中，从EBGP传来的next-hop属性在IBGP中保持不变的被传递</li>\n</ul>\n<h3 id=\"修改next-hop\"><a href=\"#修改next-hop\" class=\"headerlink\" title=\"修改next-hop\"></a>修改next-hop</h3><ul>\n<li>为了防止路由黑洞问题，R1、R2、R3建立IBGP全互联且均用各自的LOOPBACK接口建立IBGP关系</li>\n</ul>\n<h2 id=\"配置BGP\"><a href=\"#配置BGP\" class=\"headerlink\" title=\"配置BGP\"></a>配置BGP</h2><h3 id=\"基础配置\"><a href=\"#基础配置\" class=\"headerlink\" title=\"基础配置\"></a>基础配置</h3><p><code>**Router(config)# router bgp** _autonomous-system_</code></p>\n<ul>\n<li>仅仅执行router bgp不能再路由器上激活BGP，必须执行至少一个子命令才能再路由器激活BGP进程</li>\n<li>在路由器上职能配置一个BGP实例</li>\n</ul>\n<h3 id=\"指定BGP邻居及激活BGP会话\"><a href=\"#指定BGP邻居及激活BGP会话\" class=\"headerlink\" title=\"指定BGP邻居及激活BGP会话\"></a>指定BGP邻居及激活BGP会话</h3><p><code>Router(config-router)# neighbor &#123;ip-address | peer-group-name &#125; remote-as autonomous-system</code></p>\n<ul>\n<li>邻居指定的ip地址必须路由可达</li>\n<li>BGP路由都需手工指定，不能像IGP那样通过协议自动发现</li>\n<li>AS决定与邻居建立的是EBGP还是IBGP会话</li>\n</ul>\n<h3 id=\"指定BGP将通告的网络\"><a href=\"#指定BGP将通告的网络\" class=\"headerlink\" title=\"指定BGP将通告的网络\"></a>指定BGP将通告的网络</h3><p><code>Router(config-router)#network network-number [mask network-mask] [route-map map-tag]</code></p>\n<ul>\n<li>network命今与IGP不同，BGP命令network为通告哪些IP路由进BGP进程，而不是在接口上启用BGP </li>\n<li>network支持无类前缀，前缀必须与路由表中的条目完全匹配</li>\n<li>如果不指定mask，只通告主类网络号，而且仅当主类网络中至少有一个子网出现在IP路由表中，BGP才会将该主类网络作为一条BGP路由通告</li>\n<li>指定了mask，则仅当路由选择表中有与该网络完全匹配的条目时才被通告出去</li>\n</ul>\n<h3 id=\"BGP同步-1\"><a href=\"#BGP同步-1\" class=\"headerlink\" title=\"BGP同步\"></a>BGP同步</h3><p><code>Router(config-router)# no synchronization</code></p>\n<ul>\n<li>关闭同步(默认关闭)</li>\n</ul>\n<p><code>Router(config-router)# synchronization</code></p>\n<ul>\n<li>开启同步</li>\n</ul>\n<h3 id=\"BGP-router-id\"><a href=\"#BGP-router-id\" class=\"headerlink\" title=\"BGP router-id\"></a>BGP router-id</h3><p><code>Router(config-router)# bgp router-id x.x.x.x</code></p>\n<ul>\n<li>手工设置BGP routerlD</li>\n</ul>\n<h3 id=\"示例1\"><a href=\"#示例1\" class=\"headerlink\" title=\"示例1\"></a>示例1</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730894784939-f4d16b2c-c930-4ab1-a48c-c47743e91c9d.png\"></p>\n<h3 id=\"指定更新源\"><a href=\"#指定更新源\" class=\"headerlink\" title=\"指定更新源\"></a>指定更新源</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1730894818299-aa7e1866-0994-4faa-88c4-156f792c9c65.png\"></p>\n<h3 id=\"BGP身份验证\"><a href=\"#BGP身份验证\" class=\"headerlink\" title=\"BGP身份验证\"></a>BGP身份验证</h3><p>Router(config-router)# neighbor {ip-address | peer-group-name} password string</p>\n<ul>\n<li>BGP支持MD5邻居身份验证</li>\n<li>启用身份验证后，将对通过的对等体之间的TCP连接传输所有的数据等进行验证</li>\n<li>认证都是在TCP建立连接的时候完成的</li>\n</ul>\n<h2 id=\"维护BGP\"><a href=\"#维护BGP\" class=\"headerlink\" title=\"维护BGP\"></a>维护BGP</h2><ul>\n<li>重置BGP会话</li>\n<li>将新策略应用于所有路由，必须触发一个更新</li>\n</ul>\n<h3 id=\"三种触发更新的方式\"><a href=\"#三种触发更新的方式\" class=\"headerlink\" title=\"三种触发更新的方式\"></a>三种触发更新的方式</h3><ul>\n<li>硬重置</li>\n<li>软重置</li>\n<li>路由刷新</li>\n</ul>\n<h3 id=\"硬重置\"><a href=\"#硬重置\" class=\"headerlink\" title=\"硬重置\"></a>硬重置</h3><ul>\n<li>断开相应TCP连接，通过这些会话收到的所有信息都将失效，并从BGP中删除</li>\n<li>（不建议优先使用硬路由，谨慎！这将删除数据，请三思而后行！！！！）<ul>\n<li><code>clear ip bgp &#123;neighbor-address&#125;</code></li>\n<li><code>clear ip bgp *</code></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"软重置\"><a href=\"#软重置\" class=\"headerlink\" title=\"软重置\"></a>软重置</h3><ul>\n<li>不拆除并重建TCP或者BGP连接，而是仅出发更新操作以便让新的路由策略生效</li>\n<li>软重置可以仅由于出站或入站策略，也可同时用于出入站策略</li>\n</ul>\n<h4 id=\"出站软重置\"><a href=\"#出站软重置\" class=\"headerlink\" title=\"出站软重置\"></a>出站软重置</h4><ul>\n<li>不会拆除TCP连接，不会重置BGP会话，仅促发更新操作以便让新的路由策略生效（发送update消息）</li>\n<li>需要修改出站策略时，建议使用该命令</li>\n<li><code>clear ip bgp soft out</code></li>\n</ul>\n<h4 id=\"入站软重置\"><a href=\"#入站软重置\" class=\"headerlink\" title=\"入站软重置\"></a>入站软重置</h4><ul>\n<li>本地发送route-refresh给所有的BGP邻居</li>\n<li><code>clear ip bgp soft in</code></li>\n</ul>\n<p>注：CISCOIOS 12.1开始全面支持入站路由的动态软重配置，但在之前的版本在使用入站软重配置之前必须首先在BGP进程中增加如下配置:neighbor x.x.x.x soft-reconfiguration inbound然后再使用clear ip bgp soft in命令这条命令会将x.x.x.x邻居发送过来的BGP路由存储在内存中，当配置入站软重置后，路由器不再向邻居发送更新请求，而是直接在内存中存储的路由中执行新配置的入站策略，以此来防止触发大批量的路由更新而造成资源的浪费，但是这种操作仍会耗费内存，因此在使用的时候要非常慎重。</p>\n<h2 id=\"BGP属性\"><a href=\"#BGP属性\" class=\"headerlink\" title=\"BGP属性\"></a>BGP属性</h2><table>\n<thead>\n<tr>\n<th>公认属性<br>（Well-known）</th>\n<th>公认必遵<br>（Well-known mandatory）</th>\n<th>BGP 必须都能识别，且在更新消息必须包含</th>\n<th>Origin<br>AS-Path<br>Next hop</th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td>公认自决<br>（Well-known discretionary）</td>\n<td>BGP 必须都能识别，更新消息可包含可不包含</td>\n<td>Local-Preference<br>ATOMIC_Aggregate</td>\n</tr>\n<tr>\n<td>可选属性<br>（Optional）</td>\n<td>可选传递<br>（Optional transitive）</td>\n<td>可以不支持该属性，但即使不支持也应当接受包含该属性的路由并传递给其他邻居</td>\n<td>Community<br>Aggregator</td>\n</tr>\n<tr>\n<td></td>\n<td>可选非传递<br>（Opinional non-transitive）</td>\n<td>可以不支持该属性，不识别的BGP进程可以忽略包含这个属性的更新消息，并且不传递给其他BGP邻居</td>\n<td>MED<br>Originator_ID<br>Cluster_list<br>*Weight</td>\n</tr>\n</tbody></table>\n<h2 id=\"WEIGHT\"><a href=\"#WEIGHT\" class=\"headerlink\" title=\"WEIGHT\"></a>WEIGHT</h2><ul>\n<li>在路由器本地配置，只提供本地路由策略，不会传播给任何BGP邻居</li>\n<li>范围：0~65535；越大越优先</li>\n<li>路由器本地始发的路径默认权重是32768，从其他BGP邻居学到的为0</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410361179-24230caa-4101-4214-b7b2-e36684c17565.png\"></p>\n<h2 id=\"LOCAL-PREFERENCE\"><a href=\"#LOCAL-PREFERENCE\" class=\"headerlink\" title=\"LOCAL PREFERENCE\"></a>LOCAL PREFERENCE</h2><ul>\n<li><strong><font style=\"color:#DF2A3F;\">公认自由决定属性</font></strong></li>\n<li>告诉AS中的路由器，哪条路径是离开AS的首选路径</li>\n<li>LP越高路径越优</li>\n<li>只发送给IBGP邻居，而不能传给EBGP邻居</li>\n<li>默认本地优先级为100</li>\n<li><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410490396-d8420a3c-2906-416b-944d-863e909fac07.png\"></li>\n</ul>\n<h2 id=\"AS-Path（公认强制属性）\"><a href=\"#AS-Path（公认强制属性）\" class=\"headerlink\" title=\"AS-Path（公认强制属性）\"></a>AS-Path（公认强制属性）</h2><ul>\n<li>是前往目标网络的路由经过的自治系统号列表，通告该路由的自治系统号位于列表末尾</li>\n<li>作用：确认无环，通告时给EBGP时会加上自己的AS号；通告给IBGP时不修改AS-Path</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731410691990-01881309-1058-46d1-a075-114e2b239fd1.png\"></p>\n<h3 id=\"四种类型\"><a href=\"#四种类型\" class=\"headerlink\" title=\"四种类型\"></a>四种类型</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731411052266-03328819-94f7-4586-8077-d5e506eee364.png\"></p>\n<ul>\n<li>**<font style=\"color:#DF2A3F;\">AS_SET</font>**：一个去往特定目的地所经路径上的无序AS列表</li>\n<li>**<font style=\"color:#DF2A3F;\">AS_SEQENCE</font>**：一个有序的AS号列表</li>\n<li>**<font style=\"color:#DF2A3F;\">AS_CONFED_SEQUENCE</font>**：一个去往特地目的地所经路径上的有序AS号列表，其用法与AS_SEQENCE完全一样，区别于该列表的AS号属于本地联邦中的AS</li>\n<li>**<font style=\"color:#DF2A3F;\">AS_CONFED_SET</font>**：一个去往特定目的地上的无序AS号列表，其用法与AS_SET一样，区别在于列表中的AS号属于本地联邦中的AA</li>\n</ul>\n<h2 id=\"Origin（公认强制属性）\"><a href=\"#Origin（公认强制属性）\" class=\"headerlink\" title=\"Origin（公认强制属性）\"></a>Origin（公认强制属性）</h2><ul>\n<li>标识路由的起源，有下列三种可能：<ul>\n<li>i\t通过BGP network，也就是起源于IGP，因为BGP network必须保证该网络在路由表中</li>\n<li>e\t是由EGP这种早期协议重发布而来</li>\n<li>？\tIncomplete，从其他渠道学习到的，路由来源不完全（确认该路由来源的信息不完全）。（重发布的路由）</li>\n</ul>\n</li>\n<li>路由优选顺序：lowest origin code（IGP&gt;EGP&gt;Incomplete）</li>\n</ul>\n<h2 id=\"MED（可选非传递属性）\"><a href=\"#MED（可选非传递属性）\" class=\"headerlink\" title=\"MED（可选非传递属性）\"></a>MED（可选非传递属性）</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731411803897-0b6bf6f9-e658-48a4-a306-7a8d455526f8.png\"></p>\n<ul>\n<li>是一种度量值，用于外部邻居指出进入AS的首选路径，即当入口有多个时，自治系统可以使用MED动态的影响其他AS如何选择进入路径</li>\n<li>度量值越小路径越优</li>\n<li>MED是在AS之间切换，MED发送给EBGP对等体。这些路由器在AS内传播MED，不传递给下一个AS</li>\n<li>默认情况下，仅当路径来自同一个AS中的不同EBGP邻居时，路由器才比较他们的MED属性</li>\n<li>MED影响进入AS的数据流:LP影响离开AS的数据流</li>\n</ul>\n<h3 id=\"比较原则及配置注意事项\"><a href=\"#比较原则及配置注意事项\" class=\"headerlink\" title=\"比较原则及配置注意事项\"></a>比较原则及配置注意事项</h3><ul>\n<li>本地在将一条BGP路由通告给EBGP Peer时，是否携带MED值,需要根据以下条件进行判断(不对EBGP Peer使用Route-map的情况下)<ul>\n<li>如果该BGP路由是本地始发(network或redistribute)的,则携带MED值发送给EBGP Peer(如果MED为空,则设置为0)</li>\n<li>如果该BGP路由是从其他BGP Peer学习过来的，那么将该路由通告给EBGPPeer时不携带MED</li>\n</ul>\n</li>\n<li>本地在将一条BGP路由通告给IBGPPeer时，一定会携带MED值<ul>\n<li>如果接收或产生的路由的MED为空,那么在向IBGP Peer通告时,将MED设置为0</li>\n</ul>\n</li>\n<li>总结1、2两点就是MED在IBGP之间传递没有问题(不会丢失)，但是在EBGP之间传递要看路由是否起源于自己。</li>\n</ul>\n<h2 id=\"NEXT-HOP（公认强制属性）2\"><a href=\"#NEXT-HOP（公认强制属性）2\" class=\"headerlink\" title=\"NEXT_HOP（公认强制属性）2\"></a>NEXT_HOP（公认强制属性）2</h2><ul>\n<li>如果路由传递自EBGP peer</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412077866-bf31be10-26e7-4487-8738-b72ccc505e38.png\"></p>\n<ul>\n<li>如果路由传递自IBGP邻居，并描述的是AS外的目的地</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412193230-54295d0a-b300-4fea-bf2b-203de0f4a3e0.png\"></p>\n<ul>\n<li>如果路由传递自IBGP邻居，并由AS内BGP路由器引入</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731412344784-f2e1be11-a76c-4738-9ecf-dc9a4e8884c9.png\"></p>\n<p>Tips：如果IBGP peer使用network或重发布的方式引入IGP路由，那么通告者将使用这些路由的IGP下一跳作为NH；如果这些路由是该IBGP peer配置的BGP汇总路由，则NH为其更新源IP。</p>\n<h3 id=\"On-Shared-Media\"><a href=\"#On-Shared-Media\" class=\"headerlink\" title=\"On Shared Media\"></a>On Shared Media</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731413016975-73d4cf2b-a590-4d19-a73b-aeef941be1d8.png\"></p>\n<ul>\n<li>RouterB将路由100.100.100.0&#x2F;24传递给A，NEXT_HOP为10.1.123.2</li>\n<li>RouterA将路由100.100.100.0&#x2F;24传递给C，此时NEXT_HOP保持不变</li>\n<li>如果路由器收到某条BGP路由，该路由的NEXT_HOP地址值与EBGP邻居(更新对象)同属一个网段，那么该条路由的NEXTHOP地址将保持不变并传递给它的BGP邻居</li>\n</ul>\n<h3 id=\"On-NBMA\"><a href=\"#On-NBMA\" class=\"headerlink\" title=\"On NBMA\"></a>On NBMA</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731413248307-5df17964-315e-4c31-8d2b-5b159d9bcf53.png\"></p>\n<ul>\n<li>如果中间的多路访问不是Ethernet，而是帧中继（NBMA）呢？</li>\n</ul>\n<h2 id=\"COMMUNITY\"><a href=\"#COMMUNITY\" class=\"headerlink\" title=\"COMMUNITY\"></a>COMMUNITY</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731458979252-74a8f3c5-cb61-494c-8820-44d1f21f23cf.png\"></p>\n<ul>\n<li>可选传递属性</li>\n<li>一种标记，用于简化路由策略的执行</li>\n<li>可以将某些路由分配一个特定的COMMUNITY属性，之后就可以基于COMMUNITY值而不是每条路由进行BGP属性的设置了</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731460387790-d039cfe4-b94c-44ce-a4f2-0d89f944d64a.png\"></p>\n<h3 id=\"几个众所周知的值\"><a href=\"#几个众所周知的值\" class=\"headerlink\" title=\"几个众所周知的值\"></a>几个众所周知的值</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">set community ?</span><br><span class=\"line\">&lt;1-4294967295&gt;\tcommunity number</span><br><span class=\"line\">aa:nn\t\t\t\t\t\tcommunity number in aa:nn format</span><br><span class=\"line\">additive\t\t\t\tAdd to the existing community</span><br><span class=\"line\">internet\t\t\t\tInternet (well-known community)</span><br><span class=\"line\">local-AS\t\t\t\tDo not send outside local AS (well-known community)</span><br><span class=\"line\">no-advertise\t\tDo not advertise to any peer (well-known community)</span><br><span class=\"line\">no-export\t\t\t\tDo not export to next AS (well-known community)</span><br><span class=\"line\">none\t\t\t\t\t\tNo community attribute</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>Route</strong></p>\n<p>Community&#x3D;no-adv</p>\n<p>R2不会将该路由再通告给任何BGP peer</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731460836560-e5a0cea7-a8fa-4bd1-a0d9-bbefda45b523.png\"></p>\n<h2 id=\"Atomi-Aggregate及aggregator\"><a href=\"#Atomi-Aggregate及aggregator\" class=\"headerlink\" title=\"Atomi_Aggregate及aggregator\"></a>Atomi_Aggregate及aggregator</h2><p>172.16.0.0&#x2F;16</p>\n<p>汇总路由丢失明确路由的路径属性</p>\n<p>需要给下游邻居告警，并提示“汇总点”及汇总地AS</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/jpeg/44908083/1731461244712-db15a1db-b381-40ae-8c8e-83d80a966bf6.jpeg\"></p>\n<p><code>aggregate-address 172.16.0.0 255.255.0.0 summary-only</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R4# show ip bgp 172.16.0.0</span><br><span class=\"line\">BGP routing table entry for 172.16.0.0/16, version 4</span><br><span class=\"line\">Paths:(1 available, best #1, table Default-lP-Routing-Table)</span><br><span class=\"line\">Flag:0x820</span><br><span class=\"line\">Not advertised to any peer</span><br><span class=\"line\">300,(aggregated by 300 3.3.3.3)</span><br><span class=\"line\">10.1.34.3 from 10.1.34.3 (3.3.3.3)</span><br><span class=\"line\">Origin lGP, metric 0, localpref 100, valid, external,atomic-aggregate, best</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"报文案例\"><a href=\"#报文案例\" class=\"headerlink\" title=\"报文案例\"></a>报文案例</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731461667500-f2c080c5-fc71-4b5c-984c-22dcd23c405a.png\"></p>\n<h2 id=\"BGP自动汇总\"><a href=\"#BGP自动汇总\" class=\"headerlink\" title=\"BGP自动汇总\"></a>BGP自动汇总</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1731461782082-4df50a90-5604-4b26-93cd-52ae719c6130.png\"></p>\n<ul>\n<li>若R1开启auto-summary，并用重发布直连的方式引入1.1.1.0&#x2F;24，则该子网会被汇总</li>\n<li>若R1开启auto-summary,且network1.1.1.0 mask 255.255.255.0，则仍以明细更新</li>\n<li>若R1开启auto-summary,且network1.0.0.0 mask 255.0.0.0,则该子网会被汇总</li>\n<li>上面这条network等同于network 1.0.0.0(network的有类宣告)</li>\n</ul>\n<p><strong><font style=\"color:#DF2A3F;\">因此BGP自动汇总(auto-summary)只汇总重发布引入的路由，以及使用network命令有类宣告方式引入的路由。目前CISCO IOS默认关闭自动汇总。</font></strong></p>\n<h2 id=\"BGP手动汇总\"><a href=\"#BGP手动汇总\" class=\"headerlink\" title=\"BGP手动汇总\"></a><font style=\"color:#000000;\">BGP手动汇总</font></h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733121752791-989f633a-4d0d-48dd-ac50-8335ac3782e9.png\"></p>\n<ul>\n<li>可以考虑在R3上创建静态的汇总路由</li>\n</ul>\n<p><code>ip route 172.16.0.0 255.255.0.0 null0</code></p>\n<ul>\n<li>然后再将汇总路由network进BGP</li>\n<li>不推荐此方法</li>\n</ul>\n<h3 id=\"针对特定邻居取消抑制\"><a href=\"#针对特定邻居取消抑制\" class=\"headerlink\" title=\"针对特定邻居取消抑制\"></a>针对特定邻居取消抑制</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733121996017-8e7e4481-a185-40b9-85c2-3742644693c5.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access-ist 1 permit 172.16.1.0</span><br><span class=\"line\">route-map unsupp permit 10</span><br><span class=\"line\">  match ip address 11</span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\">  neighbor 10.1.35.5 unsuppress-map unsupp</span><br><span class=\"line\">  aggregate-address 172.16.0.0 255.255.0.0 as-set summary-only</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"advertise-map\"><a href=\"#advertise-map\" class=\"headerlink\" title=\"advertise-map\"></a>advertise-map</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122218668-609b391f-86ce-4a69-9cd4-22e981484fd5.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-list list1 permit 172.16.1.0/24</span><br><span class=\"line\">ip prefix-list list1 permit 172.16.2.0/24</span><br><span class=\"line\">route-map adv permit 10</span><br><span class=\"line\">  match ip address prefix-list list1</span><br><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 summary-only as-set advertise-map adv</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"attrubute-map\"><a href=\"#attrubute-map\" class=\"headerlink\" title=\"attrubute-map\"></a>attrubute-map</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122395149-ba69abf1-caa8-4996-a318-f50e5741822e.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map attr permit 10</span><br><span class=\"line\">  set ?</span><br><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 summary-only as-set attribute-map attr</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"终方案\"><a href=\"#终方案\" class=\"headerlink\" title=\"终方案\"></a>终方案</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122474434-007e0670-c4db-4dd8-9b54-e9c5ded166c2.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 summary-only as-set</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122543075-6fe96b97-2d36-4b13-9bd8-ec7c21098471.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access-list 1 permit 172.16.2.0</span><br><span class=\"line\">access-list 1 permit 172.16.11.0</span><br><span class=\"line\">route-map suppmap permit 10</span><br><span class=\"line\">  match ip address 1</span><br><span class=\"line\">aggregate-address 172.16.0.0 255.255.0.0 suppress-map suppmap</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"正则表达式\"><a href=\"#正则表达式\" class=\"headerlink\" title=\"正则表达式\"></a>正则表达式</h2><ul>\n<li>正则表达式（regular expresion）是按照一定的模板来匹配字符串的公式。</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122792066-d45f8c40-28be-44fc-9ef2-fe1d61632c39.png\"></p>\n<h3 id=\"原子字符\"><a href=\"#原子字符\" class=\"headerlink\" title=\"原子字符\"></a>原子字符</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122829384-9067e136-8d1b-4941-a29a-d059b397d1ce.png\"></p>\n<h4 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122859463-f2706ecb-995d-434a-adcd-fb3603038c63.png\"></p>\n<h3 id=\"乘法字符\"><a href=\"#乘法字符\" class=\"headerlink\" title=\"乘法字符\"></a>乘法字符</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122918646-e2bfab69-bfb0-4d20-99e2-2e598f14cf10.png\"></p>\n<h4 id=\"示例-1\"><a href=\"#示例-1\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122964843-3d32c0ca-e4f3-4de0-9ec0-3260d8a107af.png\"></p>\n<ul>\n<li>一个乘法字符可以应用于一个单字符或多个字符，如果用于多字符，需将字符串放入（ ）中</li>\n</ul>\n<h3 id=\"范围字符\"><a href=\"#范围字符\" class=\"headerlink\" title=\"范围字符\"></a>范围字符</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733122937086-5335bee7-7d2d-4911-b02c-c4bd1c6cdc3a.png\"></p>\n<h4 id=\"示例-2\"><a href=\"#示例-2\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123043302-ae7c2612-b283-4ed8-be08-c8ed67973230.png\"></p>\n<h3 id=\"使用正则表达式匹配AS-PATH\"><a href=\"#使用正则表达式匹配AS-PATH\" class=\"headerlink\" title=\"使用正则表达式匹配AS_PATH\"></a>使用正则表达式匹配AS_PATH</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123094575-e9208cd3-efbf-46e1-92d6-728495dcb98d.png\"></p>\n<ul>\n<li>AS_PATH可以当作字符串并使用正则表达式进行匹配</li>\n<li>String中的 “__” 为空格，这也是一个字符，也有可能被匹配</li>\n</ul>\n<h4 id=\"示例-3\"><a href=\"#示例-3\" class=\"headerlink\" title=\"示例\"></a>示例</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123298715-383afd98-b548-4353-bc46-54d9ee5187f6.png\"></p>\n<ul>\n<li>注意as-path access-list也是默认含隐拒绝所有</li>\n</ul>\n<h3 id=\"使用as-path-access-list-匹配路由\"><a href=\"#使用as-path-access-list-匹配路由\" class=\"headerlink\" title=\"使用as-path access-list 匹配路由\"></a>使用as-path access-list 匹配路由</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123415356-86bd5433-a930-4f66-a9a1-7d144b63fec7.png\"></p>\n<h4 id=\"示例1-搭配filter-list\"><a href=\"#示例1-搭配filter-list\" class=\"headerlink\" title=\"示例1 搭配filter-list\"></a>示例1 搭配filter-list</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123497581-877d75ef-a72f-4ab8-aa0a-e4a792edcf90.png\"></p>\n<ul>\n<li>在R3上可做策略</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip as-path access-ist 1deny _600$</span><br><span class=\"line\">ip as-path access-list 1 permit .*</span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\">  neighbor 10.1.23.2 filter-list 1 in</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"示例2-搭配route-map\"><a href=\"#示例2-搭配route-map\" class=\"headerlink\" title=\"示例2 搭配route-map\"></a>示例2 搭配route-map</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733123628617-406b7486-d886-41d5-9ed5-115603b2032f.png\"></p>\n<ul>\n<li>R3可做策略</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip as-path access-ist 1 permit _600$</span><br><span class=\"line\">route-map setCommu permit 10</span><br><span class=\"line\">  match as-path 1</span><br><span class=\"line\">  set community no-advertise</span><br><span class=\"line\">route-map setCommu permit 10</span><br><span class=\"line\"></span><br><span class=\"line\">router bgp 300</span><br><span class=\"line\">  neighbor 10.1.23.2 route-map setcommu in</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置命令\"><a href=\"#配置命令\" class=\"headerlink\" title=\"配置命令\"></a>配置命令</h3><p><code>Router(config)# ip as-path access-list num &#123;permit|deny&#125; regexp</code></p>\n<ul>\n<li>配置as-path access-list</li>\n</ul>\n<p><code>Router(config-router)# neighbor x.x.x.x filter-list as-path-filter &#123;inlout&#125;</code></p>\n<ul>\n<li>关联as-path access-list到filter-list，起到路由过滤作用</li>\n</ul>\n<h4 id=\"验证及查看\"><a href=\"#验证及查看\" class=\"headerlink\" title=\"验证及查看\"></a>验证及查看</h4><p><code>Router# show ip as-path-access-list</code></p>\n<ul>\n<li>查看配置的 as-path access-list</li>\n</ul>\n<p><code>Router# show ip bgp regexp xx</code></p>\n<ul>\n<li>显示BGP表中所有被该正则表达式匹配上的路由，这是一个非常不错的工具</li>\n</ul>\n<p><code>Router# show ip bgp filter-list access-list-num</code></p>\n<ul>\n<li>显示BGP表中所有被该filter-list匹配的路由</li>\n</ul>\n<h2 id=\"通告community操控路由\"><a href=\"#通告community操控路由\" class=\"headerlink\" title=\"通告community操控路由\"></a>通告community操控路由</h2><h3 id=\"BGP-Communities\"><a href=\"#BGP-Communities\" class=\"headerlink\" title=\"BGP Communities\"></a>BGP Communities</h3><ul>\n<li>BGP communities是一种路由标记方法，用于确保路由过滤和选择的连续性</li>\n<li>可选传递属性，不支持该属性的BGP router原封不动的将community值传递给下游BGP邻居</li>\n</ul>\n<h3 id=\"Community\"><a href=\"#Community\" class=\"headerlink\" title=\"Community\"></a>Community</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124090787-e2d027b9-f95b-466a-b5e8-86d7bdb3805c.png\"></p>\n<ul>\n<li>使用全局配置命令切换：</li>\n</ul>\n<p><code>ip bgp-community new-format</code></p>\n<h3 id=\"BGP路径操纵\"><a href=\"#BGP路径操纵\" class=\"headerlink\" title=\"BGP路径操纵\"></a>BGP路径操纵</h3><h4 id=\"设置Community\"><a href=\"#设置Community\" class=\"headerlink\" title=\"设置Community\"></a>设置Community</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">set community ?</span><br><span class=\"line\">&lt;1-4294967295&gt;\t\tcommunity number</span><br><span class=\"line\">aa:nn\t\t\t\t\t\t\tcommunity number in aa:nn format</span><br><span class=\"line\">additive\t\t\t\t\tAdd to the existing community</span><br><span class=\"line\">internet\t\t\t\t\tInternet(well-known community)</span><br><span class=\"line\">local-AS\t\t\t\t\tDo not send outside local AS (well-known community)</span><br><span class=\"line\">no-advertise\t\t\tDo not advertise to any peer (well-known community)</span><br><span class=\"line\">no-export\t\t\t\t\tDo not export to next AS (well-known community)</span><br><span class=\"line\">none\t\t\t\t\t\t\tNo community attribute</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总所周知的值\"><a href=\"#总所周知的值\" class=\"headerlink\" title=\"总所周知的值\"></a>总所周知的值</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124385448-cf61fcfb-a43e-4fb0-b8af-97b8e047e12d.png\"></p>\n<p><strong>Route</strong></p>\n<ul>\n<li>Community&#x3D;local-as</li>\n<li>该路由只能在本AS内传递（如果定义了联邦，则为只在联邦成员AS传递）</li>\n</ul>\n<h3 id=\"为路由前缀分配Community\"><a href=\"#为路由前缀分配Community\" class=\"headerlink\" title=\"为路由前缀分配Community\"></a>为路由前缀分配Community</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124481538-4caea059-33d5-4c50-89d2-305d5b25bf67.png\"></p>\n<ul>\n<li>R1配置如下：</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-ist 11 permit 11.11.11.0/24</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  match ip address prefix-list 11</span><br><span class=\"line\">  set community 100:11</span><br><span class=\"line\">  </span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\">  network 11.11.11.0 mask 255.255.255.0</span><br><span class=\"line\">  neighbor 10.1.12.2 remote-as 200</span><br><span class=\"line\">  neighbor 10.1.12.2 send-community</span><br><span class=\"line\">  neighbor 10.1.12.2 route-map test out</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为路由前缀分配多个Community\"><a href=\"#为路由前缀分配多个Community\" class=\"headerlink\" title=\"为路由前缀分配多个Community\"></a>为路由前缀分配多个Community</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124672973-08971d75-7687-4f0c-a733-782014d85b5c.png\"></p>\n<ul>\n<li>R2的配置如下：</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-ist 11 permit 100:11</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  match community 11</span><br><span class=\"line\">  set community no-export additive</span><br><span class=\"line\"></span><br><span class=\"line\">router bgp 200</span><br><span class=\"line\">  neighbor 10.1.12.1 remote-as 100</span><br><span class=\"line\">  neighbor 10.1.23.3 remote-as 300</span><br><span class=\"line\">  neighbor 10.1.23.3 send-community</span><br><span class=\"line\">  neighbor 10.1.23.3 route-map test out</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"为路由前缀分配多个Community（cont-）\"><a href=\"#为路由前缀分配多个Community（cont-）\" class=\"headerlink\" title=\"为路由前缀分配多个Community（cont.）\"></a>为路由前缀分配多个Community（cont.）</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124846029-37b26bce-3e5b-41e6-949a-f6f5eca0889c.png\"></p>\n<ul>\n<li>R3上查看11.11.11.0的BGP路由：</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R3#sh ip b 11.11.11.0</span><br><span class=\"line\">BGP routing table entry for 11.11.11.0/24,version 5</span><br><span class=\"line\">Paths:(1 available, best #1, table Default-P-Routing-Table, not advertised</span><br><span class=\"line\">to EBGP peer)</span><br><span class=\"line\">Flag:0x820</span><br><span class=\"line\">  Not advertised to any peer</span><br><span class=\"line\">  200 100</span><br><span class=\"line\">    10.1.23.2 from 10.1.23.2 10.1.23.2)</span><br><span class=\"line\">    Origin lGP, localpref 100, valid, external, best</span><br><span class=\"line\">    Community:100:11 no-export</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用community-list匹配团体属性\"><a href=\"#用community-list匹配团体属性\" class=\"headerlink\" title=\"用community-list匹配团体属性\"></a>用community-list匹配团体属性</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733124981265-f03cbe06-2d35-4141-82f4-4bc934728879.png\"></p>\n<p><code>lp community-list 1 permit 100:11</code></p>\n<ul>\n<li>匹配。匹配community中包含100:11的路由</li>\n</ul>\n<p><code>lp community-list 1 permit 100:11 no-adv</code></p>\n<ul>\n<li>不匹配。要求100:11及no-adv两者都有才匹配成立</li>\n</ul>\n<p><code>lp community-list 1 permit 100:11</code></p>\n<p><code>Ip community-list 1 permit no-export(或将no-export换成no-adv)</code></p>\n<ul>\n<li>匹配。只要community中包含100:11或no-export</li>\n</ul>\n<h3 id=\"用community-list匹配团体属性（cont-）\"><a href=\"#用community-list匹配团体属性（cont-）\" class=\"headerlink\" title=\"用community-list匹配团体属性（cont.）\"></a>用community-list匹配团体属性（cont.）</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125149714-85e3e77c-fab0-4cb2-aae7-d89f093f56c3.png\"></p>\n<p><code>ip community-list 12 permit internet</code></p>\n<ul>\n<li>所有路由默认都属于internet</li>\n</ul>\n<h3 id=\"用community-list匹配团体属性-严格匹配\"><a href=\"#用community-list匹配团体属性-严格匹配\" class=\"headerlink\" title=\"用community-list匹配团体属性 严格匹配\"></a>用community-list匹配团体属性 严格匹配</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125250291-e5171d9b-624d-4446-b988-3117e17dd97d.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lp community-list 11 permit no-export</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">match community 11 exact-match\t\t// 严格匹配</span><br><span class=\"line\">严格匹配community属性为no-export的路由，多一点，少一点都不行</span><br><span class=\"line\"></span><br><span class=\"line\">Show lp community-ist 1 [exact-match]</span><br><span class=\"line\">查看community-list 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除某个或多个community值\"><a href=\"#删除某个或多个community值\" class=\"headerlink\" title=\"删除某个或多个community值\"></a>删除某个或多个community值</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125335491-71efe10e-6c26-4e45-afe6-6f30821e8c97.png\"></p>\n<ul>\n<li><strong>一条路由，允许携带多个community值，构成一个community列表，那么如何删除某个或者某几个community值?譬如只想删除11路由的no-export属性</strong></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-list standard del permit no-export\t\t// 匹配要删除的commu值</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  set comm-list del delete\t\t// 用这条命令删除</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除多个community值\"><a href=\"#删除多个community值\" class=\"headerlink\" title=\"删除多个community值\"></a>删除多个community值</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125474298-a0ab0f1a-bc22-46f8-bce2-e8fcd77cebf0.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-list standard del permit no-export\t\t// 用多行community-list</span><br><span class=\"line\">ip community-list standard del permit 100:11\t\t// 用多行community-list</span><br><span class=\"line\">route-map test permit 10</span><br><span class=\"line\">  set comm-list del delete</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置community-list\"><a href=\"#配置community-list\" class=\"headerlink\" title=\"配置community-list\"></a>配置community-list</h3><p><code>lp community-list 1-99 permit|deny value [value...]</code></p>\n<p>定义标准的community-list，使用internet关键字匹配任何community</p>\n<p><code>lp community-list 100-199 permit|deny regexp</code></p>\n<p>定义扩展的community-list，可使用正则表达式匹配community</p>\n<p><code>show ip community-list</code></p>\n<p>查看配置的community-list</p>\n<p><code>show ip bgp x.x.x.x</code></p>\n<p>查看BGP路由的详细信息，包括community</p>\n<h2 id=\"Prefix-list\"><a href=\"#Prefix-list\" class=\"headerlink\" title=\"Prefix-list\"></a>Prefix-list</h2><h3 id=\"配置实例\"><a href=\"#配置实例\" class=\"headerlink\" title=\"配置实例\"></a>配置实例</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125724825-5fc79afd-ba57-4220-a7e3-c07cbc16d21f.png\"></p>\n<ul>\n<li>R2上，过滤掉12.12.12.0&#x2F;24路由，其他放行</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2(config)# ip prefix-list 12 deny 12.12.12.0/24</span><br><span class=\"line\">R2(config)# ip prefix-list 12 permit 0.0.0.0/0 le 32</span><br><span class=\"line\">R2(config)# router bgp 12</span><br><span class=\"line\">R2(config-router)# neighbor 10.1.23.3 prefix-list 12 out</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"distribute-list\"><a href=\"#distribute-list\" class=\"headerlink\" title=\"distribute-list\"></a>distribute-list</h2><h3 id=\"配置实例-1\"><a href=\"#配置实例-1\" class=\"headerlink\" title=\"配置实例\"></a>配置实例</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733125796770-bb717766-917b-4aca-9dce-e03e43310a11.png\"></p>\n<ul>\n<li>R2上，过滤掉12.12.12.0&#x2F;24路由，其他放行</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">R2(config)# access-ist 1 deny 12.12.12.0</span><br><span class=\"line\">R2(config)# access-list 1 permit any</span><br><span class=\"line\">R2(config)# router bgp 12</span><br><span class=\"line\">R2(config-router)# neighbor 10.1.23.3 distribute-list 1 out</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Route-map\"><a href=\"#Route-map\" class=\"headerlink\" title=\"Route-map\"></a>Route-map</h2><h3 id=\"可以在以下的BGP命令中使用route-map关键字\"><a href=\"#可以在以下的BGP命令中使用route-map关键字\" class=\"headerlink\" title=\"可以在以下的BGP命令中使用route-map关键字\"></a>可以在以下的BGP命令中使用route-map关键字</h3><ul>\n<li>neighbor</li>\n<li>bgp dampening</li>\n<li>network</li>\n<li>redistribute</li>\n</ul>\n<h3 id=\"可以为特定的目的在不同的命令中调用定义好的route-map\"><a href=\"#可以为特定的目的在不同的命令中调用定义好的route-map\" class=\"headerlink\" title=\"可以为特定的目的在不同的命令中调用定义好的route-map\"></a>可以为特定的目的在不同的命令中调用定义好的route-map</h3><ul>\n<li>suppress-map</li>\n<li>unsuppress-map</li>\n<li>advertise-map</li>\n<li>inject-map</li>\n<li>exist-map</li>\n<li>non-exist-map</li>\n<li>tabel-map</li>\n</ul>\n<h3 id=\"match语句能匹配\"><a href=\"#match语句能匹配\" class=\"headerlink\" title=\"match语句能匹配\"></a>match语句能匹配</h3><ul>\n<li>Access-list</li>\n<li>Ip prefix-list</li>\n<li>Ip next-hop</li>\n<li>local-preference</li>\n<li>metric</li>\n<li>Tag</li>\n<li>AS PATH</li>\n<li>BGP community</li>\n<li>IGP route-type(internal&#x2F;external)</li>\n</ul>\n<h3 id=\"set语句能设置\"><a href=\"#set语句能设置\" class=\"headerlink\" title=\"set语句能设置\"></a>set语句能设置</h3><ul>\n<li>Origin</li>\n<li>Weight</li>\n<li>BGP community</li>\n<li>LOCAL PREFERENCE</li>\n<li>MED</li>\n</ul>\n<h3 id=\"配置实例-关联network-执行策略\"><a href=\"#配置实例-关联network-执行策略\" class=\"headerlink\" title=\"配置实例 关联network 执行策略\"></a>配置实例 关联network 执行策略</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126321432-30b4a9e2-5670-4e5c-b28e-b11d6398051b.png\"></p>\n<ul>\n<li><em><strong>R1上，network引入路由时设置路径属性</strong></em></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-list 11 permit 11.11.11.0/24</span><br><span class=\"line\">ip prefix-ist 12 permit 12.12.12.0/24</span><br><span class=\"line\">route-map RP1 permit 10</span><br><span class=\"line\">  set community 100:11</span><br><span class=\"line\">route-map RP2 permit 20</span><br><span class=\"line\">  set community 100:12</span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\">  network 11.11.11.0 mask 255.255.255.0 route-map RP1</span><br><span class=\"line\">  network 12.12.12.0 mask 255.255.255.0 route-map RP2</span><br><span class=\"line\">  neighbor 10.1.12.2 send-community</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>该策略对所有BGP邻居有效</strong></li>\n</ul>\n<h3 id=\"关联neighbor，针对特定邻居执行策略\"><a href=\"#关联neighbor，针对特定邻居执行策略\" class=\"headerlink\" title=\"关联neighbor，针对特定邻居执行策略\"></a>关联neighbor，针对特定邻居执行策略</h3><p><strong>R1上，对R2传递路由时，设定MED属性值</strong></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126749376-550e409c-c6c6-419c-8ca7-fa6ec14c3a1d.png\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip prefix-list 11 permit 11.11.11.0/24</span><br><span class=\"line\">ip prefix-list 12 permit 12.12.12.0/24</span><br><span class=\"line\">route-map RP permit 10</span><br><span class=\"line\">  match ip address 11</span><br><span class=\"line\">  set metric 1000</span><br><span class=\"line\">route-map RP permit 20</span><br><span class=\"line\">  match ip address 12</span><br><span class=\"line\">  set metric 2000</span><br><span class=\"line\">router bgp 100</span><br><span class=\"line\">  neighbor 10.1.12.2 route-map RP out</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置实例-重发布关联route-map\"><a href=\"#配置实例-重发布关联route-map\" class=\"headerlink\" title=\"配置实例 重发布关联route-map\"></a>配置实例 重发布关联route-map</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733126794524-8909f174-b61c-467b-9e8e-4a56528ab197.png\"></p>\n<p><strong>R2上，将OSPF路由重发布进BGP</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router bgp 200</span><br><span class=\"line\">redistribute ospf 1 route-map RP match ?</span><br><span class=\"line\">neighbor 10.1.12.1 remote-as 100</span><br><span class=\"line\">no auto-summary</span><br></pre></td></tr></table></figure>\n\n<p><strong>redistribute ospf 1</strong></p>\n<ul>\n<li>默认只重发布Intra-Area及Inter-Area路由</li>\n<li>match extemnal只重发布E1及E2</li>\n<li>match external 1只重发布E1;external 2只重发布E2</li>\n<li>match nssa-external 只重发布NSSA外部路由</li>\n</ul>\n<h3 id=\"Policy-list\"><a href=\"#Policy-list\" class=\"headerlink\" title=\"Policy-list\"></a>Policy-list</h3><ul>\n<li>可预先将包含一组match语句的route-map定义成一个命令列表，这个列表称为policy-list</li>\n<li>这些policy-list可以在route-map中被调用</li>\n<li>一个policy-list就像个只包含match语句的route-map当route-map被执行，被其调用的policy-list中所包含的match语句将一并被遍历且执行match动作</li>\n<li>这是一种在大中型网络中运用、使得配置“模块化”的特性</li>\n</ul>\n<h4 id=\"特性\"><a href=\"#特性\" class=\"headerlink\" title=\"特性\"></a>特性</h4><ul>\n<li>Ipv6不支持</li>\n<li>12.0(22)S 和12.2(15)T之前的CISCOIOS版本不支持该特性，另外更老的IOS版本的路由器重启存在路由策略配置丢失的风险</li>\n<li>Policy-list中不能包含set语句，但是它被route-map调用后，该route-map中可以包含set语句</li>\n<li>Policy-list只在BGP中支持，其他的IP路由协议并不支持这个特性</li>\n</ul>\n<h4 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip policy-list as100 permit</span><br><span class=\"line\">  match as-path 1</span><br><span class=\"line\">  match community 1</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>上述命令创建一个policy-list</li>\n<li>Policy-list只能包含match语句</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-map RP permit 10</span><br><span class=\"line\">  match policy-list as100</span><br><span class=\"line\">  match ip address prefix-list 100</span><br><span class=\"line\">  set local-preference 300</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>上述命令在route-map中调用定义好的policy-list</li>\n<li>一个route-map中可调用多个policy-list</li>\n</ul>\n<h2 id=\"ORF\"><a href=\"#ORF\" class=\"headerlink\" title=\"ORF\"></a>ORF</h2><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127261820-c5da6b86-80e8-429d-bc1a-2a6100b878e4.png\"></p>\n<h3 id=\"配置-1\"><a href=\"#配置-1\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127420812-f87e5d92-541e-4e91-91ee-8da2c7342e7e.png\"></p>\n<ul>\n<li>R2的配置（sender）</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router bgp 12</span><br><span class=\"line\">  address-family ipv4 unicast</span><br><span class=\"line\">  neighbor 10.1.12.1 capability orf prefix-ist send</span><br><span class=\"line\">  neighbor 10.1.12.1 prefix-list FILTER in</span><br><span class=\"line\"></span><br><span class=\"line\">ip prefix-ist FlLTER deny 1.1.1.0/24</span><br><span class=\"line\">ip prefix-list FlLTER permit</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>R1的配置（receiver）</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router bgp 12</span><br><span class=\"line\">  address-family ipv4 unicast</span><br><span class=\"line\">  neighbor 10.1.12.2 capability orf prefix-list receive</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>注意：省去基本配置，如手工指定BGP邻居</li>\n</ul>\n<h3 id=\"一些\"><a href=\"#一些\" class=\"headerlink\" title=\"一些\"></a>一些</h3><ul>\n<li>ORF消息包含以下内容<ul>\n<li>AFl&#x2F;SAFlipv4 unicast</li>\n<li>ORF TYPE</li>\n<li>When to refresh</li>\n<li>List of ORF entries</li>\n</ul>\n</li>\n<li>ORF类型不同，ORFentries也不尽相同</li>\n<li>每种ORF类型都需要进行ORF能力的协商</li>\n</ul>\n<h2 id=\"路由拆分-BGP-Deaggregation\"><a href=\"#路由拆分-BGP-Deaggregation\" class=\"headerlink\" title=\"路由拆分 BGP Deaggregation\"></a>路由拆分 BGP Deaggregation</h2><h3 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733127855820-e4b03bc3-1426-46bb-b770-6e35ac5f0b46.png\"></p>\n<h3 id=\"配置-2\"><a href=\"#配置-2\" class=\"headerlink\" title=\"配置\"></a>配置</h3><ul>\n<li>Conditional inject的配置如下(BGP路由选择进程模式下)</li>\n</ul>\n<p><code>bgp inject-map map1 exist-map map2 [copy attributes]</code></p>\n<ul>\n<li>上述命令的意思是当map2所匹配的汇总路由正常时，在本地BGP RIB中注入map1中定义的明细路由。</li>\n<li>当汇总路由挂掉，这条明细也就跟着消失，这就是所谓的条件注入-conditional injection。</li>\n<li>下面我们在看来一下这两个route-map的详细内容，这些是需要格外注意的。</li>\n<li>exist-map使用的route-map最少具有以下两个match语句</li>\n</ul>\n<p><code>match ip address prefix-list</code></p>\n<ul>\n<li>上面这条match语句用来匹配汇总路由</li>\n</ul>\n<p><code>match ip route-source</code></p>\n<ul>\n<li>上面这条match语句用来匹配发送该汇总路由的邻居IP。如果指定了copyattributes选项，那么被inject的明细路由会继承汇总路由的路径属性，否则明细将被当成本地生成的路由。</li>\n<li>Inject-map使用的route-map中</li>\n</ul>\n<p><code>Set ip address prefix-list</code></p>\n<ul>\n<li>上面的这条set命令用来定义将被注入到本地BGPRIB的明细路由。被注入的前缀可以使用</li>\n</ul>\n<p><code>Show ip bgpinjected-path</code></p>\n<ul>\n<li>来显示</li>\n</ul>\n<h2 id=\"路由反射器\"><a href=\"#路由反射器\" class=\"headerlink\" title=\"路由反射器\"></a>路由反射器</h2><h3 id=\"中转AS中的IBGP问题\"><a href=\"#中转AS中的IBGP问题\" class=\"headerlink\" title=\"中转AS中的IBGP问题\"></a>中转AS中的IBGP问题</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733138789405-9509b338-52b2-4cd0-b7b8-716ee84b829a.png\"></p>\n<ul>\n<li>AS内要求IBGP全互联（IBGP水平分割）</li>\n<li>BGP routers<ul>\n<li>需维护大量的TCP和BGP链接</li>\n<li>网络中充斥着BGP路由信息</li>\n</ul>\n</li>\n<li>解决方案<ul>\n<li>路由反射器</li>\n<li>BGP联邦</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"背景-1\"><a href=\"#背景-1\" class=\"headerlink\" title=\"背景\"></a>背景</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733138923248-9e3c4eb2-ccea-4481-8feb-28e80a14bd4e.png\"></p>\n<ul>\n<li>因为IBGP水平分割原则，导致AS内部需要维护大量的BGP链接（要求IBGP全互联），从而影响网络性能，路由反射器可以“放宽”水平分割原则，缓解该问题</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139053948-4ababdc6-fc58-4813-a03b-65e6b92fa662.png\"></p>\n<ul>\n<li>Route Reflector</li>\n<li>Client</li>\n</ul>\n<h3 id=\"联邦内的BGP路由路径属性\"><a href=\"#联邦内的BGP路由路径属性\" class=\"headerlink\" title=\"联邦内的BGP路由路径属性\"></a>联邦内的BGP路由路径属性</h3><ul>\n<li>在联邦内部保留外部路由的NEXT_HOP属性</li>\n<li>公布给联邦的路由的MED属性在整个联邦范围内予以保留</li>\n<li>路由的LP属性在整个联邦范围内予以保留</li>\n<li>在联邦范围内，将成员AS号压入AS PATH，但不公布到联邦外，并且使用TYPE3、4的AS PATH</li>\n<li>AS PATH中的联邦成员AS号用于在联邦内部避免环路;联邦内成员AS号不参与AS PATH长度计算</li>\n</ul>\n<h3 id=\"路由反射原则\"><a href=\"#路由反射原则\" class=\"headerlink\" title=\"路由反射原则\"></a>路由反射原则</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139094878-a409c072-6d0f-48f0-8f54-d88dc4810e2a.png\"></p>\n<ul>\n<li>如果路由学习自非client IBGP对等体，则反射给所有client</li>\n<li>如果路由学习自—client，则反射给所有非client IBGP邻居和除了该client以外的所有client</li>\n<li>如果路由学习自EBGP邻居，则发送给所有的client和非client IBGP邻居</li>\n</ul>\n<h3 id=\"实例1\"><a href=\"#实例1\" class=\"headerlink\" title=\"实例1\"></a>实例1</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139249267-49816366-cad0-4367-bc94-0694daae41ae.png\"></p>\n<ul>\n<li>如果路由学习自一client，则反射给所有非client IBGP邻居和除了该client以外的所有client</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139304799-ced25330-ed76-4b30-8385-39709a182131.png\"></p>\n<ul>\n<li>如果路由学习至自client IBG对等体，则反射给所有的client</li>\n</ul>\n<h3 id=\"路由反射器下的防环\"><a href=\"#路由反射器下的防环\" class=\"headerlink\" title=\"路由反射器下的防环\"></a>路由反射器下的防环</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733139376642-4f17a413-a0ac-4a12-b60a-b5f67e6af3da.png\"></p>\n<ul>\n<li>由于AS PATH属性在AS内部不会发生变化(仅当路由离开本AS才会被更新)，因此AS内才有水平分割的机制用于防止环路，而路由反射器实际上是放宽了水平分割原则，这个就会给环路带来一定的隐患，因此路由反射器需使用以下两个属性防止环路ORIGINATOR ID和CLUSTER LIST是路由反射器使用的可选非传递属性，用来防止环路。</li>\n</ul>\n<h3 id=\"Originator-ID、Cluster-list\"><a href=\"#Originator-ID、Cluster-list\" class=\"headerlink\" title=\"Originator_ID、Cluster_list\"></a>Originator_ID、Cluster_list</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140109190-57da2edc-e4e2-44dd-859d-498ca74c3909.png\"></p>\n<h4 id=\"Originator-ID\"><a href=\"#Originator-ID\" class=\"headerlink\" title=\"Originator_ID\"></a>Originator_ID</h4><ul>\n<li>每当一条路由被路由反射器反射时，该路由的始发IBGP路由器的Router-ID将会被存在路由的originator_ID属性中</li>\n<li>当一台路由器收到IBGP路由且其originatorID与该路由器的RouterID相同，则路由器忽略该条路由</li>\n<li>Originator_ID及Cluster-list属性将会影响BGP路径决策</li>\n</ul>\n<h4 id=\"Originator-ID的值\"><a href=\"#Originator-ID的值\" class=\"headerlink\" title=\"Originator_ID的值\"></a>Originator_ID的值</h4><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140502948-58450af4-a6d4-4764-b425-43380d718b4b.png\"></p>\n<h3 id=\"路由反射原则-1\"><a href=\"#路由反射原则-1\" class=\"headerlink\" title=\"路由反射原则\"></a>路由反射原则</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140292005-dd4b4b29-9070-492d-9038-64a94ac51f6e.png\"></p>\n<ul>\n<li>如果路由学习自非client lBGP对等体，则反射给所有client</li>\n<li>如果路由学习自一client，则反射给所有非ctientIBGP邻居和除了该client以外的所有client</li>\n<li>如果路由学习自EBGP邻居，则发送给所有client和非clientIBGP邻居</li>\n</ul>\n<h3 id=\"路由反射簇\"><a href=\"#路由反射簇\" class=\"headerlink\" title=\"路由反射簇\"></a>路由反射簇</h3><ul>\n<li>路由反射簇包括反射器及其Client</li>\n<li>每一个簇都有唯一的簇ID</li>\n<li>每当一条路由被反射器反射后，该反射器(该簇)的ClusterID就会被添加至路由的Cluster list属性中</li>\n<li>每当反射器收到一条Cluster list属性已经包含该簇的ClusterID的路由时，该路由基于防环的目的将不被反射</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140660257-05943ad7-9a7c-4dab-af52-05dac354ea2b.png\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140718784-4731164f-0b69-4428-b4ff-cbeeaab41843.png\"></p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733140920126-45d22e04-6ac7-4ea2-b433-4ecf734da20a.png\"></p>\n<h3 id=\"路由反射器冗余\"><a href=\"#路由反射器冗余\" class=\"headerlink\" title=\"路由反射器冗余\"></a>路由反射器冗余</h3><p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733141230441-a00716c4-3db4-4a6c-9fb7-535cd4ebe1d1.png\"></p>\n<ul>\n<li>冗余RR增加了网络的健壮性</li>\n<li>使用Originator IDCluster_list属性来在冗余RR环境中避免路由环路。</li>\n<li>例如将两个RR 的Cluster_ID配置为一样，那么可以起到进一步的防环作用</li>\n<li>所有的RR之间建议采用IBGP全互联</li>\n<li>Client会收到来自两个RR反射的路由，如何决策 ?</li>\n</ul>\n<h3 id=\"BGP选路规则\"><a href=\"#BGP选路规则\" class=\"headerlink\" title=\"BGP选路规则\"></a>BGP选路规则</h3><ol>\n<li>优选具有最大Weight值的路由</li>\n<li>优选具有最大Local Pref值的路由</li>\n<li>优选起源于本地的路由(如本地networkaggregate或redistribute的)即下一跳是0.0.0.0(在BGP 表中,当前路由器通告的路由的下一跳为0.0.0.0)</li>\n<li>优选AS-Path最短的路由</li>\n<li>Origin(IGP &gt;EGP&gt;Incomplete )</li>\n<li>优选MED最小的路由，默认情况下仅有当所有的备选路由来自同一AS才会比较MED</li>\n<li>优选EBGP邻居发来的路由(相对于IBGP邻居学过来的)，在联邦EBGP和IBGP中首选联邦EBGP 路由</li>\n<li>优选到BGP NEXT HOP最近的邻居</li>\n<li>如果有多条来自相同相邻AS的路由并通过Maximum-paths 使多条路径可用,则将所有开销相同的路由放入Loc-RIB</li>\n<li>优选最老的EBGP路由，降低滚翻的影响(此条主要对EBGP路由起效，但是现在基本不用该条，因不确定性太大)</li>\n<li>BGP 邻居的RID越小越优先</li>\n<li>优选Cluster-List 最短的路由</li>\n<li>选择邻居ip地址(BGP的neighbor配置中的那个地址)最小的路由</li>\n</ol>\n<h2 id=\"优选MED最小的路由\"><a href=\"#优选MED最小的路由\" class=\"headerlink\" title=\"优选MED最小的路由\"></a>优选MED最小的路由</h2><h3 id=\"MED属性设置方法\"><a href=\"#MED属性设置方法\" class=\"headerlink\" title=\"MED属性设置方法\"></a>MED属性设置方法</h3><ul>\n<li>将IGP路由引入BGP时关联Route-map进行设置</li>\n<li>对BGP Peer应用IN&#x2F;OUT方向的Route-map进行设置</li>\n<li>非Route-map(自动)方式<ul>\n<li>使用network或redistribute方式将IGP路由引入BGP时,MED将继承IGP路由的Metric(直联路由及静态路由的Metric为0)</li>\n<li>使用aggregate-address方式引入路由，则MED为空</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"MED注意事项\"><a href=\"#MED注意事项\" class=\"headerlink\" title=\"MED注意事项\"></a>MED注意事项</h3><ul>\n<li>默认情况下，只比较来自同一邻居AS的BGP路由的MED值，就是说如果同一个目的地的两条路由来自不同的AS，则不进行MED值的比较。如果仍然希望比较来自不同邻接AS的路由，可使用如下命令</li>\n<li><code>bgp always-compare-med</code></li>\n<li>MED只是在直接相连的自治系统间影响业务量，而不会跨AS传递</li>\n</ul>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2024/png/44908083/1733208543904-53fea48b-83db-441b-964d-f8c27e92a6ee.png\"></p>\n<h2 id=\"BGP负载均衡\"><a href=\"#BGP负载均衡\" class=\"headerlink\" title=\"BGP负载均衡\"></a>BGP负载均衡</h2><ul>\n<li>当前面的8条选路原则都无法优选出最优路由时，并且在BGP进程下面配置了maximum-paths[ibgp]n,n的取值为2-6,那么将执行等价负载均衡，也就是将这些等代价的BGP路径都放进IP路由表使用，但是要注意，虽然这些路径在本地都用了，最终却只有一条BGP路径是best最优的。具备等价负载均衡条件的候选路径需满足如下条件:<ul>\n<li>必须有相同的路径属性，如weight、LP、AS PATH(不仅是长度，整个AS PATH包括AS号都要相同)、origincode、MED及IGP的Distance值</li>\n<li>每一条路径的下一跳都不相同</li>\n</ul>\n</li>\n</ul>\n<p>__</p>\n","categories":[{"name":"思科","path":"api/categories/思科.json"}],"tags":[{"name":"网络","path":"api/tags/网络.json"},{"name":"CCNP","path":"api/tags/CCNP.json"}]}